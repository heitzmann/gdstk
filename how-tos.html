

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>How-Tos &mdash; gdstk 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=34bb78ad" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="_static/tabs.css?v=4c969af8" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=a12e3537"></script>
      <script src="_static/doctools.js?v=fd6eb6e6"></script>
      <script src="_static/sphinx_highlight.js?v=6ffebe34"></script>
      <script src="_static/tabs.js?v=3ee01567"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Python API Reference" href="reference_python.html" />
    <link rel="prev" title="Getting Started" href="gettingstarted.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            gdstk
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="gettingstarted.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">How-Tos</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#parametric-cell">Parametric Cell</a></li>
<li class="toctree-l2"><a class="reference internal" href="#parts-library">Parts Library</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#creating-a-library">Creating a Library</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-a-library">Using a Library</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#merging-libraries">Merging Libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="#transformations">Transformations</a></li>
<li class="toctree-l2"><a class="reference internal" href="#repetitions">Repetitions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#geometry-filtering">Geometry Filtering</a></li>
<li class="toctree-l2"><a class="reference internal" href="#points-along-a-path">Points Along a Path</a></li>
<li class="toctree-l2"><a class="reference internal" href="#connection-pads">Connection Pads</a></li>
<li class="toctree-l2"><a class="reference internal" href="#system-fonts">System Fonts</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="reference_python.html">Python API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="reference_cpp.html">C++ Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">gdstk</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">How-Tos</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="how-tos">
<span id="id1"></span><h1>How-Tos<a class="headerlink" href="#how-tos" title="Link to this heading"></a></h1>
<p>These are a few examples of use of the Gdstk library that go beyond basic
geometry building.  They should serve as reference for more complex tasks.</p>
<section id="parametric-cell">
<span id="id2"></span><h2>Parametric Cell<a class="headerlink" href="#parametric-cell" title="Link to this heading"></a></h2>
<p>A parametric cell is a concept present in a few layout editors to facilitate
the creation of geometries based on user-defined parameters.  Gdstk does not
have a parameterized cell class, but since we are building the layout from a
programming language, the full flexibility of the language can be used.</p>
<p>In this example we define a function that returns a grating coupler based on
user-defined parameters.</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--0-input--1" name="tab-set--0" type="radio" /><label class="tab-label" for="tab-set--0-input--1">Python</label><div class="tab-content docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">grating</span><span class="p">(</span>
    <span class="n">period</span><span class="p">,</span> <span class="n">fill_frac</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cell_name</span><span class="o">=</span><span class="s2">&quot;Grating&quot;</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Straight grating:</span>

<span class="sd">    Args:</span>
<span class="sd">        period: Grating period.</span>
<span class="sd">        fill_frac: Filling fraction of the teeth (wrt period).</span>
<span class="sd">        length: Length of the grating.</span>
<span class="sd">        width: Width of the grating.</span>
<span class="sd">        layer: GDSII layer number</span>
<span class="sd">        datatype: GDSII data type number</span>

<span class="sd">    Return:</span>
<span class="sd">        gdstk.Cell</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Cell</span><span class="p">(</span><span class="n">cell_name</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">period</span> <span class="o">*</span> <span class="n">fill_frac</span>
    <span class="n">result</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">gdstk</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span>
            <span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">*</span> <span class="n">period</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">*</span> <span class="n">period</span> <span class="o">+</span> <span class="n">w</span><span class="p">),</span> <span class="n">layer</span><span class="o">=</span><span class="n">layer</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">datatype</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">length</span> <span class="o">/</span> <span class="n">period</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p>This function can be used in the following manner:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">lib</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Library</span><span class="p">()</span>

    <span class="n">length</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">grat1</span> <span class="o">=</span> <span class="n">grating</span><span class="p">(</span><span class="mf">3.5</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cell_name</span><span class="o">=</span><span class="s2">&quot;Grating 1&quot;</span><span class="p">)</span>
    <span class="n">grat2</span> <span class="o">=</span> <span class="n">grating</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cell_name</span><span class="o">=</span><span class="s2">&quot;Grating 2&quot;</span><span class="p">)</span>
    <span class="n">lib</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">grat1</span><span class="p">,</span> <span class="n">grat2</span><span class="p">)</span>

    <span class="n">main</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">new_cell</span><span class="p">(</span><span class="s2">&quot;Main&quot;</span><span class="p">)</span>
    <span class="n">main</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gdstk</span><span class="o">.</span><span class="n">rectangle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">),</span> <span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">10</span><span class="p">)))</span>
    <span class="n">main</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gdstk</span><span class="o">.</span><span class="n">Reference</span><span class="p">(</span><span class="n">grat1</span><span class="p">,</span> <span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">rotation</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">main</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gdstk</span><span class="o">.</span><span class="n">Reference</span><span class="p">(</span><span class="n">grat2</span><span class="p">,</span> <span class="p">(</span><span class="mi">150</span> <span class="o">-</span> <span class="n">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">rotation</span><span class="o">=-</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
    <span class="n">lib</span><span class="o">.</span><span class="n">write_gds</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;pcell.gds&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--0-input--2" name="tab-set--0" type="radio" /><label class="tab-label" for="tab-set--0-input--2">C++</label><div class="tab-content docutils container">
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;gdstk/gdstk.hpp&gt;</span>

<span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">gdstk</span><span class="p">;</span>

<span class="n">Cell</span><span class="o">*</span><span class="w"> </span><span class="nf">grating</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">period</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">fill_frac</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">Tag</span><span class="w"> </span><span class="n">tag</span><span class="p">,</span>
<span class="w">              </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">period</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">fill_frac</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int64_t</span><span class="p">)(</span><span class="n">length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">period</span><span class="p">);</span>

<span class="w">    </span><span class="n">Cell</span><span class="o">*</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Cell</span><span class="o">*</span><span class="p">)</span><span class="n">allocate_clear</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Cell</span><span class="p">));</span>
<span class="w">    </span><span class="n">result</span><span class="o">-&gt;</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">copy_string</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">result</span><span class="o">-&gt;</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">ensure_slots</span><span class="p">(</span><span class="n">num</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int64_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">period</span><span class="p">;</span>
<span class="w">        </span><span class="n">Polygon</span><span class="o">*</span><span class="w"> </span><span class="n">rect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Polygon</span><span class="o">*</span><span class="p">)</span><span class="n">allocate</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Polygon</span><span class="p">));</span>
<span class="w">        </span><span class="o">*</span><span class="n">rect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rectangle</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="o">-</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">},</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">w</span><span class="p">},</span><span class="w"> </span><span class="n">tag</span><span class="p">);</span>
<span class="w">        </span><span class="n">result</span><span class="o">-&gt;</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">rect</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Library</span><span class="w"> </span><span class="n">lib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="s">&quot;library&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">1e-6</span><span class="p">,</span><span class="w"> </span><span class="mf">1e-9</span><span class="p">);</span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span>

<span class="w">    </span><span class="n">Cell</span><span class="o">*</span><span class="w"> </span><span class="n">grat1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">grating</span><span class="p">(</span><span class="mf">3.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="n">make_tag</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Grating 1&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">cell_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">grat1</span><span class="p">);</span>

<span class="w">    </span><span class="n">Cell</span><span class="o">*</span><span class="w"> </span><span class="n">grat2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">grating</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="n">make_tag</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Grating 2&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">cell_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">grat2</span><span class="p">);</span>

<span class="w">    </span><span class="n">Cell</span><span class="o">*</span><span class="w"> </span><span class="n">main_cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Cell</span><span class="o">*</span><span class="p">)</span><span class="n">allocate_clear</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Cell</span><span class="p">));</span>
<span class="w">    </span><span class="n">main_cell</span><span class="o">-&gt;</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">copy_string</span><span class="p">(</span><span class="s">&quot;Main&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">cell_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">main_cell</span><span class="p">);</span>

<span class="w">    </span><span class="n">Polygon</span><span class="o">*</span><span class="w"> </span><span class="n">rect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Polygon</span><span class="o">*</span><span class="p">)</span><span class="n">allocate</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Polygon</span><span class="p">));</span>
<span class="w">    </span><span class="o">*</span><span class="n">rect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rectangle</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">-10</span><span class="p">},</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="mi">150</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">},</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">main_cell</span><span class="o">-&gt;</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">rect</span><span class="p">);</span>

<span class="w">    </span><span class="n">Reference</span><span class="o">*</span><span class="w"> </span><span class="n">ref1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Reference</span><span class="o">*</span><span class="p">)</span><span class="n">allocate_clear</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Reference</span><span class="p">));</span>
<span class="w">    </span><span class="n">ref1</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">grat1</span><span class="p">);</span>
<span class="w">    </span><span class="n">ref1</span><span class="o">-&gt;</span><span class="n">origin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">};</span>
<span class="w">    </span><span class="n">ref1</span><span class="o">-&gt;</span><span class="n">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M_PI</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="n">main_cell</span><span class="o">-&gt;</span><span class="n">reference_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref1</span><span class="p">);</span>

<span class="w">    </span><span class="n">Reference</span><span class="o">*</span><span class="w"> </span><span class="n">ref2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Reference</span><span class="o">*</span><span class="p">)</span><span class="n">allocate_clear</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Reference</span><span class="p">));</span>
<span class="w">    </span><span class="n">ref2</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReferenceType</span><span class="o">::</span><span class="n">Cell</span><span class="p">,</span><span class="w"> </span><span class="n">ref2</span><span class="o">-&gt;</span><span class="n">cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">grat2</span><span class="p">,</span><span class="w"> </span><span class="n">ref2</span><span class="o">-&gt;</span><span class="n">origin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="mi">150</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span>
<span class="w">    </span><span class="n">ref2</span><span class="o">-&gt;</span><span class="n">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">M_PI</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">ref2</span><span class="o">-&gt;</span><span class="n">magnification</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">main_cell</span><span class="o">-&gt;</span><span class="n">reference_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref2</span><span class="p">);</span>

<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">write_gds</span><span class="p">(</span><span class="s">&quot;pcell.gds&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">free_all</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<img alt="_images/parametric_cell.svg" class="align-center" src="_images/parametric_cell.svg" />
</section>
<section id="parts-library">
<h2>Parts Library<a class="headerlink" href="#parts-library" title="Link to this heading"></a></h2>
<section id="creating-a-library">
<h3>Creating a Library<a class="headerlink" href="#creating-a-library" title="Link to this heading"></a></h3>
<p>A GDSII parts library can be used when there are several devices that are often
used in different layouts.  It can be a personal library of devices, or part of
a process design kit (PDK) offered by the company responsible for fabrication.</p>
<p>Here we create a simple personal library with 3 components: an alignment mark,
a directional coupler and a Mach-Zehnder interferometer.  All parts are added
to a GDSII file and saved for later.  Note that the interferometer already uses
the directional coupler as a subcomponent.</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--1-input--1" name="tab-set--1" type="radio" /><label class="tab-label" for="tab-set--1-input--1">Python</label><div class="tab-content docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pathlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gdstk</span>


<span class="k">def</span><span class="w"> </span><span class="nf">alignment_mark</span><span class="p">(</span><span class="n">lib</span><span class="p">):</span>
    <span class="n">cross</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">cross</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">lib</span><span class="o">.</span><span class="n">new_cell</span><span class="p">(</span><span class="s2">&quot;Alignment Mark&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cross</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">directional_coupler</span><span class="p">(</span><span class="n">lib</span><span class="p">):</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">RobustPath</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="n">simple_path</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">path</span><span class="o">.</span><span class="n">segment</span><span class="p">((</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">path</span><span class="o">.</span><span class="n">segment</span><span class="p">((</span><span class="mf">2.2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">offset</span><span class="o">=</span><span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="s2">&quot;smooth&quot;</span><span class="p">),</span> <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">path</span><span class="o">.</span><span class="n">segment</span><span class="p">((</span><span class="mf">0.4</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">path</span><span class="o">.</span><span class="n">segment</span><span class="p">((</span><span class="mf">2.2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">offset</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;smooth&quot;</span><span class="p">),</span> <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">path</span><span class="o">.</span><span class="n">segment</span><span class="p">((</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">lib</span><span class="o">.</span><span class="n">new_cell</span><span class="p">(</span><span class="s2">&quot;Directinal Coupler&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">mach_zehnder_interferometer</span><span class="p">(</span><span class="n">lib</span><span class="p">):</span>
    <span class="n">cell</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">new_cell</span><span class="p">(</span><span class="s2">&quot;MZI&quot;</span><span class="p">)</span>
    <span class="n">cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gdstk</span><span class="o">.</span><span class="n">Reference</span><span class="p">(</span><span class="s2">&quot;Directinal Coupler&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
    <span class="n">cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gdstk</span><span class="o">.</span><span class="n">Reference</span><span class="p">(</span><span class="s2">&quot;Directinal Coupler&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">75</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>

    <span class="n">points</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">40</span><span class="p">),</span> <span class="p">(</span><span class="mi">55</span><span class="p">,</span> <span class="mi">40</span><span class="p">),</span> <span class="p">(</span><span class="mi">55</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">75</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>
    <span class="n">arm1</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">FlexPath</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">bend_radius</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">simple_path</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">arm2</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">FlexPath</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">bend_radius</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">simple_path</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">40</span><span class="p">),</span> <span class="p">(</span><span class="mi">55</span><span class="p">,</span> <span class="mi">40</span><span class="p">),</span> <span class="p">(</span><span class="mi">55</span><span class="p">,</span> <span class="mi">20</span><span class="p">)])</span>
    <span class="n">heater1</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">FlexPath</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">bend_radius</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">simple_path</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">heater2</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">FlexPath</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">bend_radius</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">simple_path</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">arm1</span><span class="p">,</span> <span class="n">arm2</span><span class="p">,</span> <span class="n">heater1</span><span class="p">,</span> <span class="n">heater2</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">lib</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Library</span><span class="p">(</span><span class="s2">&quot;Photonics&quot;</span><span class="p">)</span>

    <span class="n">alignment_mark</span><span class="p">(</span><span class="n">lib</span><span class="p">)</span>
    <span class="n">directional_coupler</span><span class="p">(</span><span class="n">lib</span><span class="p">)</span>
    <span class="n">mach_zehnder_interferometer</span><span class="p">(</span><span class="n">lib</span><span class="p">)</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
    <span class="n">lib</span><span class="o">.</span><span class="n">write_gds</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;photonics.gds&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--1-input--2" name="tab-set--1" type="radio" /><label class="tab-label" for="tab-set--1-input--2">C++</label><div class="tab-content docutils container">
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;gdstk/gdstk.hpp&gt;</span>

<span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">gdstk</span><span class="p">;</span>

<span class="n">Cell</span><span class="o">*</span><span class="w"> </span><span class="nf">alignment_mark</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Cell</span><span class="o">*</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Cell</span><span class="o">*</span><span class="p">)</span><span class="n">allocate_clear</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Cell</span><span class="p">));</span>
<span class="w">    </span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">copy_string</span><span class="p">(</span><span class="s">&quot;Alignment Mark&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="n">Polygon</span><span class="o">*</span><span class="w"> </span><span class="n">cross_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Polygon</span><span class="o">*</span><span class="p">)</span><span class="n">allocate</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Polygon</span><span class="p">));</span>
<span class="w">    </span><span class="o">*</span><span class="n">cross_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cross</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">make_tag</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="w">    </span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">cross_</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">cell</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">Cell</span><span class="o">*</span><span class="w"> </span><span class="nf">directional_coupler</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Cell</span><span class="o">*</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Cell</span><span class="o">*</span><span class="p">)</span><span class="n">allocate_clear</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Cell</span><span class="p">));</span>
<span class="w">    </span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">copy_string</span><span class="p">(</span><span class="s">&quot;Directional Coupler&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">widths</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">};</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">offsets</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">};</span>
<span class="w">    </span><span class="n">Tag</span><span class="w"> </span><span class="n">tags</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">make_tag</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">make_tag</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)};</span>
<span class="w">    </span><span class="n">RobustPath</span><span class="o">*</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">RobustPath</span><span class="o">*</span><span class="p">)</span><span class="n">allocate_clear</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">RobustPath</span><span class="p">));</span>
<span class="w">    </span><span class="n">path</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">widths</span><span class="p">,</span><span class="w"> </span><span class="n">offsets</span><span class="p">,</span><span class="w"> </span><span class="mf">0.01</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="n">tags</span><span class="p">);</span>

<span class="w">    </span><span class="n">Interpolation</span><span class="w"> </span><span class="n">offset</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="w">    </span><span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InterpolationType</span><span class="o">::</span><span class="n">Smooth</span><span class="p">;</span>
<span class="w">    </span><span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">initial_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">final_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-0.3</span><span class="p">;</span>
<span class="w">    </span><span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InterpolationType</span><span class="o">::</span><span class="n">Smooth</span><span class="p">;</span>
<span class="w">    </span><span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">initial_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">final_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.3</span><span class="p">;</span>
<span class="w">    </span><span class="n">offset</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InterpolationType</span><span class="o">::</span><span class="n">Smooth</span><span class="p">;</span>
<span class="w">    </span><span class="n">offset</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">initial_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-0.3</span><span class="p">;</span>
<span class="w">    </span><span class="n">offset</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">final_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="n">offset</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InterpolationType</span><span class="o">::</span><span class="n">Smooth</span><span class="p">;</span>
<span class="w">    </span><span class="n">offset</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">initial_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.3</span><span class="p">;</span>
<span class="w">    </span><span class="n">offset</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">final_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">    </span><span class="n">path</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">    </span><span class="n">path</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mf">2.2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">    </span><span class="n">path</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mf">0.4</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">    </span><span class="n">path</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mf">2.2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">    </span><span class="n">path</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">    </span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">robustpath_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">cell</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">Cell</span><span class="o">*</span><span class="w"> </span><span class="nf">mach_zenhder_interferometer</span><span class="p">(</span><span class="n">Cell</span><span class="o">*</span><span class="w"> </span><span class="n">directional_coupler_cell</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Cell</span><span class="o">*</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Cell</span><span class="o">*</span><span class="p">)</span><span class="n">allocate_clear</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Cell</span><span class="p">));</span>
<span class="w">    </span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">copy_string</span><span class="p">(</span><span class="s">&quot;MZI&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="n">Reference</span><span class="o">*</span><span class="w"> </span><span class="n">ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Reference</span><span class="o">*</span><span class="p">)</span><span class="n">allocate_clear</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Reference</span><span class="p">));</span>
<span class="w">    </span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">directional_coupler_cell</span><span class="p">);</span>
<span class="w">    </span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">reference_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>

<span class="w">    </span><span class="n">ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Reference</span><span class="o">*</span><span class="p">)</span><span class="n">allocate_clear</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Reference</span><span class="p">));</span>
<span class="w">    </span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">directional_coupler_cell</span><span class="p">);</span>
<span class="w">    </span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">origin</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">75</span><span class="p">;</span>
<span class="w">    </span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">reference_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">Vec2</span><span class="w"> </span><span class="n">starting_points</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="mi">-20</span><span class="p">}};</span>
<span class="w">    </span><span class="n">FlexPath</span><span class="o">*</span><span class="w"> </span><span class="n">path</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int64_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">COUNT</span><span class="p">(</span><span class="n">path</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">FlexPath</span><span class="o">*</span><span class="p">)</span><span class="n">allocate_clear</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">FlexPath</span><span class="p">));</span>
<span class="w">        </span><span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">simple_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">        </span><span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">starting_points</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.01</span><span class="p">,</span><span class="w"> </span><span class="n">make_tag</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="w">        </span><span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bend_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BendType</span><span class="o">::</span><span class="n">Circular</span><span class="p">;</span>
<span class="w">        </span><span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bend_radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">15</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">Vec2</span><span class="w"> </span><span class="n">arm_points</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mi">55</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mi">55</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mi">75</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">}};</span>
<span class="w">    </span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">({.</span><span class="n">capacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">COUNT</span><span class="p">(</span><span class="n">arm_points</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arm_points</span><span class="p">},</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">                     </span><span class="nb">false</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int64_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">COUNT</span><span class="p">(</span><span class="n">arm_points</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="n">arm_points</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">arm_points</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y</span><span class="p">;</span>
<span class="w">    </span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">({.</span><span class="n">capacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">COUNT</span><span class="p">(</span><span class="n">arm_points</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arm_points</span><span class="p">},</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">                     </span><span class="nb">false</span><span class="p">);</span>

<span class="w">    </span><span class="n">Vec2</span><span class="w"> </span><span class="n">heater_points</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mi">55</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mi">55</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">}};</span>
<span class="w">    </span><span class="n">path</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">({.</span><span class="n">capacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">COUNT</span><span class="p">(</span><span class="n">heater_points</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">heater_points</span><span class="p">},</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">                     </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int64_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">COUNT</span><span class="p">(</span><span class="n">heater_points</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="n">heater_points</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">heater_points</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y</span><span class="p">;</span>
<span class="w">    </span><span class="n">path</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">({.</span><span class="n">capacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">COUNT</span><span class="p">(</span><span class="n">heater_points</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">heater_points</span><span class="p">},</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
<span class="w">                     </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>

<span class="w">    </span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">flexpath_array</span><span class="p">.</span><span class="n">extend</span><span class="p">({.</span><span class="n">capacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">COUNT</span><span class="p">(</span><span class="n">path</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path</span><span class="p">});</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">cell</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Library</span><span class="w"> </span><span class="n">lib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="s">&quot;Photonics&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">1e-6</span><span class="p">,</span><span class="w"> </span><span class="mf">1e-9</span><span class="p">);</span>
<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">cell_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">alignment_mark</span><span class="p">());</span>
<span class="w">    </span><span class="n">Cell</span><span class="o">*</span><span class="w"> </span><span class="n">directional_coupler_cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">directional_coupler</span><span class="p">();</span>
<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">cell_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">directional_coupler_cell</span><span class="p">);</span>
<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">cell_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">mach_zenhder_interferometer</span><span class="p">(</span><span class="n">directional_coupler_cell</span><span class="p">));</span>
<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">write_gds</span><span class="p">(</span><span class="s">&quot;photonics.gds&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">free_all</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="using-a-library">
<span id="id3"></span><h3>Using a Library<a class="headerlink" href="#using-a-library" title="Link to this heading"></a></h3>
<p>The library “photonics.gds” created above is used in the design of a larger
layout.  It is imported through <a class="reference internal" href="library/gdstk.read_rawcells.html#gdstk.read_rawcells" title="gdstk.read_rawcells"><code class="xref py py-func docutils literal notranslate"><span class="pre">gdstk.read_rawcells()</span></code></a> so that is uses as
little memory and processing power as possible.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Using <cite>gdstk.RawCell</cite> will only work properly when both the library and the
current layout use the same unit and precision.</p>
</div>
<p>Another option for creating libraries is to store them as python modules.  The
grating example in <a class="reference internal" href="#parametric-cell"><span class="std std-ref">Parametric Cell</span></a> can be saved in a file “photonics.py”
and imported as a Python module, as long as it can be found in the Python path
(leaving it in the current working directory is sufficient).</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--2-input--1" name="tab-set--2" type="radio" /><label class="tab-label" for="tab-set--2-input--1">Python</label><div class="tab-content docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pathlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gdstk</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pcell</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>

    <span class="c1"># Check library units. In this case it is using the default units.</span>
    <span class="n">units</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">gds_units</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;photonics.gds&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using unit = </span><span class="si">{</span><span class="n">units</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, precision = </span><span class="si">{</span><span class="n">units</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Load the library as a dictionary of RawCell</span>
    <span class="n">pdk</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">read_rawcells</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;photonics.gds&quot;</span><span class="p">)</span>

    <span class="c1"># Cell holding a single device (MZI)</span>
    <span class="n">dev_cell</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Cell</span><span class="p">(</span><span class="s2">&quot;Device&quot;</span><span class="p">)</span>
    <span class="n">dev_cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gdstk</span><span class="o">.</span><span class="n">Reference</span><span class="p">(</span><span class="n">pdk</span><span class="p">[</span><span class="s2">&quot;MZI&quot;</span><span class="p">],</span> <span class="p">(</span><span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>

    <span class="c1"># Create a grating coupler using the function imported from the</span>
    <span class="c1"># pcell module (pcell.py) created earlier.</span>
    <span class="n">grating</span> <span class="o">=</span> <span class="n">pcell</span><span class="o">.</span><span class="n">grating</span><span class="p">(</span><span class="mf">0.62</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># Add 4 grating couplers to the device cell: one for each port.</span>
    <span class="n">dev_cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">gdstk</span><span class="o">.</span><span class="n">Reference</span><span class="p">(</span>
            <span class="n">grating</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">200</span><span class="p">,</span> <span class="o">-</span><span class="mi">150</span><span class="p">),</span> <span class="n">rotation</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="n">gdstk</span><span class="o">.</span><span class="n">Reference</span><span class="p">(</span>
            <span class="n">grating</span><span class="p">,</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span> <span class="n">rotation</span><span class="o">=-</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Create a waveguide connecting a grating to a MZI port.</span>
    <span class="n">waveguide</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">FlexPath</span><span class="p">((</span><span class="o">-</span><span class="mi">220</span><span class="p">,</span> <span class="o">-</span><span class="mi">150</span><span class="p">),</span> <span class="mi">20</span><span class="p">,</span> <span class="n">bend_radius</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Grating background</span>
    <span class="n">waveguide</span><span class="o">.</span><span class="n">segment</span><span class="p">((</span><span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Linear taper</span>
    <span class="n">waveguide</span><span class="o">.</span><span class="n">segment</span><span class="p">((</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="o">-</span><span class="mi">150</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="c1"># Connection to MZI</span>
    <span class="n">waveguide</span><span class="o">.</span><span class="n">segment</span><span class="p">([(</span><span class="o">-</span><span class="mi">70</span><span class="p">,</span> <span class="o">-</span><span class="mi">150</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">70</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)])</span>
    <span class="c1"># Since the device is symmetrical, we can create a cell with the</span>
    <span class="c1"># waveguide geometry and reuse it for all 4 ports.</span>
    <span class="n">wg_cell</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Cell</span><span class="p">(</span><span class="s2">&quot;Waveguide&quot;</span><span class="p">)</span>
    <span class="n">wg_cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">waveguide</span><span class="p">)</span>

    <span class="n">dev_cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gdstk</span><span class="o">.</span><span class="n">Reference</span><span class="p">(</span><span class="n">wg_cell</span><span class="p">))</span>
    <span class="n">dev_cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gdstk</span><span class="o">.</span><span class="n">Reference</span><span class="p">(</span><span class="n">wg_cell</span><span class="p">,</span> <span class="n">x_reflection</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="n">dev_cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gdstk</span><span class="o">.</span><span class="n">Reference</span><span class="p">(</span><span class="n">wg_cell</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
    <span class="n">dev_cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gdstk</span><span class="o">.</span><span class="n">Reference</span><span class="p">(</span><span class="n">wg_cell</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">x_reflection</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="c1"># Main cell with 2 devices and lithography alignment marks</span>
    <span class="n">main</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Cell</span><span class="p">(</span><span class="s2">&quot;Main&quot;</span><span class="p">)</span>
    <span class="n">main</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">gdstk</span><span class="o">.</span><span class="n">Reference</span><span class="p">(</span><span class="n">dev_cell</span><span class="p">,</span> <span class="p">(</span><span class="mi">250</span><span class="p">,</span> <span class="mi">250</span><span class="p">)),</span>
        <span class="n">gdstk</span><span class="o">.</span><span class="n">Reference</span><span class="p">(</span><span class="n">dev_cell</span><span class="p">,</span> <span class="p">(</span><span class="mi">250</span><span class="p">,</span> <span class="mi">750</span><span class="p">)),</span>
        <span class="n">gdstk</span><span class="o">.</span><span class="n">Reference</span><span class="p">(</span><span class="n">pdk</span><span class="p">[</span><span class="s2">&quot;Alignment Mark&quot;</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">500</span><span class="p">)),</span>
    <span class="p">)</span>

    <span class="n">lib</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Library</span><span class="p">()</span>
    <span class="n">lib</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="o">*</span><span class="n">main</span><span class="o">.</span><span class="n">dependencies</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
    <span class="n">lib</span><span class="o">.</span><span class="n">write_gds</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;layout.gds&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--2-input--2" name="tab-set--2" type="radio" /><label class="tab-label" for="tab-set--2-input--2">C++</label><div class="tab-content docutils container">
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;gdstk/gdstk.hpp&gt;</span>

<span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">gdstk</span><span class="p">;</span>

<span class="c1">// We redefine the grating function from pcell.cpp here instead of including</span>
<span class="c1">// the file because it contains a main function already.  In practice, the</span>
<span class="c1">// library source would only contain the relevant functions, but no main.</span>
<span class="n">Cell</span><span class="o">*</span><span class="w"> </span><span class="nf">grating</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">period</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">fill_frac</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">Tag</span><span class="w"> </span><span class="n">tag</span><span class="p">,</span>
<span class="w">              </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">period</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">fill_frac</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int64_t</span><span class="p">)(</span><span class="n">length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">period</span><span class="p">);</span>

<span class="w">    </span><span class="n">Cell</span><span class="o">*</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Cell</span><span class="o">*</span><span class="p">)</span><span class="n">allocate_clear</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Cell</span><span class="p">));</span>
<span class="w">    </span><span class="n">result</span><span class="o">-&gt;</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">copy_string</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">result</span><span class="o">-&gt;</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">ensure_slots</span><span class="p">(</span><span class="n">num</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int64_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">period</span><span class="p">;</span>
<span class="w">        </span><span class="n">Polygon</span><span class="o">*</span><span class="w"> </span><span class="n">rect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Polygon</span><span class="o">*</span><span class="p">)</span><span class="n">allocate</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Polygon</span><span class="p">));</span>
<span class="w">        </span><span class="o">*</span><span class="n">rect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rectangle</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="o">-</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">},</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">w</span><span class="p">},</span><span class="w"> </span><span class="n">tag</span><span class="p">);</span>
<span class="w">        </span><span class="n">result</span><span class="o">-&gt;</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">rect</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">precision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">ErrorCode</span><span class="w"> </span><span class="n">error_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gds_units</span><span class="p">(</span><span class="s">&quot;photonics.gds&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">unit</span><span class="p">,</span><span class="w"> </span><span class="n">precision</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error_code</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ErrorCode</span><span class="o">::</span><span class="n">NoError</span><span class="p">)</span><span class="w"> </span><span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Using unit = %.3g, precision = %.3g</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">unit</span><span class="p">,</span><span class="w"> </span><span class="n">precision</span><span class="p">);</span>

<span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">RawCell</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">pdk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_rawcells</span><span class="p">(</span><span class="s">&quot;photonics.gds&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="n">Cell</span><span class="o">*</span><span class="w"> </span><span class="n">dev_cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Cell</span><span class="o">*</span><span class="p">)</span><span class="n">allocate_clear</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Cell</span><span class="p">));</span>
<span class="w">    </span><span class="n">dev_cell</span><span class="o">-&gt;</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">copy_string</span><span class="p">(</span><span class="s">&quot;Device&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="n">Reference</span><span class="o">*</span><span class="w"> </span><span class="n">mzi_ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Reference</span><span class="o">*</span><span class="p">)</span><span class="n">allocate_clear</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Reference</span><span class="p">));</span>
<span class="w">    </span><span class="n">mzi_ref</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">pdk</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;MZI&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="n">mzi_ref</span><span class="o">-&gt;</span><span class="n">origin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="mi">-40</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">};</span>
<span class="w">    </span><span class="n">dev_cell</span><span class="o">-&gt;</span><span class="n">reference_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">mzi_ref</span><span class="p">);</span>

<span class="w">    </span><span class="n">Cell</span><span class="o">*</span><span class="w"> </span><span class="n">grating_cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">grating</span><span class="p">(</span><span class="mf">0.62</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="n">make_tag</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Grating&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// We set type of these references to Regular so that we can apply the</span>
<span class="w">    </span><span class="c1">// rotation to the translation vectors v1 and v2 of the repetition. This</span>
<span class="w">    </span><span class="c1">// way, the GDSII writer will create and AREF element instead of multiple</span>
<span class="w">    </span><span class="c1">// SREFs. If x_reflection was set to true, that would also have to be</span>
<span class="w">    </span><span class="c1">// applied to v2 for an AREF to be created.</span>
<span class="w">    </span><span class="n">Reference</span><span class="o">*</span><span class="w"> </span><span class="n">grating_ref1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Reference</span><span class="o">*</span><span class="p">)</span><span class="n">allocate_clear</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Reference</span><span class="p">));</span>
<span class="w">    </span><span class="n">grating_ref1</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">grating_cell</span><span class="p">);</span>
<span class="w">    </span><span class="n">grating_ref1</span><span class="o">-&gt;</span><span class="n">origin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="mi">-200</span><span class="p">,</span><span class="w"> </span><span class="mi">-150</span><span class="p">};</span>
<span class="w">    </span><span class="n">grating_ref1</span><span class="o">-&gt;</span><span class="n">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M_PI</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="n">grating_ref1</span><span class="o">-&gt;</span><span class="n">repetition</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RepetitionType</span><span class="o">::</span><span class="n">Regular</span><span class="p">;</span>
<span class="w">    </span><span class="n">grating_ref1</span><span class="o">-&gt;</span><span class="n">repetition</span><span class="p">.</span><span class="n">columns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="n">grating_ref1</span><span class="o">-&gt;</span><span class="n">repetition</span><span class="p">.</span><span class="n">rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">grating_ref1</span><span class="o">-&gt;</span><span class="n">repetition</span><span class="p">.</span><span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">300</span><span class="p">};</span>
<span class="w">    </span><span class="n">grating_ref1</span><span class="o">-&gt;</span><span class="n">repetition</span><span class="p">.</span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">};</span>
<span class="w">    </span><span class="n">dev_cell</span><span class="o">-&gt;</span><span class="n">reference_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">grating_ref1</span><span class="p">);</span>

<span class="w">    </span><span class="n">Reference</span><span class="o">*</span><span class="w"> </span><span class="n">grating_ref2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Reference</span><span class="o">*</span><span class="p">)</span><span class="n">allocate_clear</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Reference</span><span class="p">));</span>
<span class="w">    </span><span class="n">grating_ref2</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">grating_cell</span><span class="p">);</span>
<span class="w">    </span><span class="n">grating_ref2</span><span class="o">-&gt;</span><span class="n">origin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="mi">150</span><span class="p">};</span>
<span class="w">    </span><span class="n">grating_ref2</span><span class="o">-&gt;</span><span class="n">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">M_PI</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="n">grating_ref2</span><span class="o">-&gt;</span><span class="n">repetition</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RepetitionType</span><span class="o">::</span><span class="n">Regular</span><span class="p">;</span>
<span class="w">    </span><span class="n">grating_ref2</span><span class="o">-&gt;</span><span class="n">repetition</span><span class="p">.</span><span class="n">columns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="n">grating_ref2</span><span class="o">-&gt;</span><span class="n">repetition</span><span class="p">.</span><span class="n">rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">grating_ref2</span><span class="o">-&gt;</span><span class="n">repetition</span><span class="p">.</span><span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">-300</span><span class="p">};</span>
<span class="w">    </span><span class="n">grating_ref2</span><span class="o">-&gt;</span><span class="n">repetition</span><span class="p">.</span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">};</span>

<span class="w">    </span><span class="n">dev_cell</span><span class="o">-&gt;</span><span class="n">reference_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">grating_ref2</span><span class="p">);</span>

<span class="w">    </span><span class="n">FlexPath</span><span class="o">*</span><span class="w"> </span><span class="n">waveguide</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">FlexPath</span><span class="o">*</span><span class="p">)</span><span class="n">allocate_clear</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">FlexPath</span><span class="p">));</span>
<span class="w">    </span><span class="n">waveguide</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mi">-220</span><span class="p">,</span><span class="w"> </span><span class="mi">-150</span><span class="p">},</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.01</span><span class="p">,</span><span class="w"> </span><span class="n">make_tag</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="w">    </span><span class="n">waveguide</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bend_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BendType</span><span class="o">::</span><span class="n">Circular</span><span class="p">;</span>
<span class="w">    </span><span class="n">waveguide</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bend_radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">15</span><span class="p">;</span>

<span class="w">    </span><span class="n">waveguide</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="p">;</span>
<span class="w">    </span><span class="n">waveguide</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mi">-100</span><span class="p">,</span><span class="w"> </span><span class="mi">-150</span><span class="p">},</span><span class="w"> </span><span class="o">&amp;</span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>

<span class="w">    </span><span class="n">Vec2</span><span class="w"> </span><span class="n">p</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mi">-70</span><span class="p">,</span><span class="w"> </span><span class="mi">-150</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mi">-70</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mi">-40</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">}};</span>
<span class="w">    </span><span class="n">waveguide</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">({.</span><span class="n">capacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">COUNT</span><span class="p">(</span><span class="n">p</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">},</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>

<span class="w">    </span><span class="n">Cell</span><span class="o">*</span><span class="w"> </span><span class="n">wg_cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Cell</span><span class="o">*</span><span class="p">)</span><span class="n">allocate_clear</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Cell</span><span class="p">));</span>
<span class="w">    </span><span class="n">wg_cell</span><span class="o">-&gt;</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">copy_string</span><span class="p">(</span><span class="s">&quot;Waveguide&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">wg_cell</span><span class="o">-&gt;</span><span class="n">flexpath_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">waveguide</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Reference</span><span class="o">*</span><span class="w"> </span><span class="n">wg_ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Reference</span><span class="o">*</span><span class="p">)</span><span class="n">allocate_clear</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Reference</span><span class="p">));</span>
<span class="w">        </span><span class="n">wg_ref</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">wg_cell</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">wg_ref</span><span class="o">-&gt;</span><span class="n">x_reflection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">wg_ref</span><span class="o">-&gt;</span><span class="n">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M_PI</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">wg_ref</span><span class="o">-&gt;</span><span class="n">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M_PI</span><span class="p">;</span>
<span class="w">            </span><span class="n">wg_ref</span><span class="o">-&gt;</span><span class="n">x_reflection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">dev_cell</span><span class="o">-&gt;</span><span class="n">reference_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">wg_ref</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">Cell</span><span class="o">*</span><span class="w"> </span><span class="n">main_cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Cell</span><span class="o">*</span><span class="p">)</span><span class="n">allocate_clear</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Cell</span><span class="p">));</span>
<span class="w">    </span><span class="n">main_cell</span><span class="o">-&gt;</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">copy_string</span><span class="p">(</span><span class="s">&quot;Main&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Reference</span><span class="o">*</span><span class="w"> </span><span class="n">dev_ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Reference</span><span class="o">*</span><span class="p">)</span><span class="n">allocate_clear</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Reference</span><span class="p">));</span>
<span class="w">        </span><span class="n">dev_ref</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">dev_cell</span><span class="p">);</span>
<span class="w">        </span><span class="n">dev_ref</span><span class="o">-&gt;</span><span class="n">origin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="mi">250</span><span class="p">,</span><span class="w"> </span><span class="mi">250</span><span class="p">}</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="mi">250</span><span class="p">,</span><span class="w"> </span><span class="mi">750</span><span class="p">};</span>
<span class="w">        </span><span class="n">main_cell</span><span class="o">-&gt;</span><span class="n">reference_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">dev_ref</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">Reference</span><span class="o">*</span><span class="w"> </span><span class="n">align_ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Reference</span><span class="o">*</span><span class="p">)</span><span class="n">allocate_clear</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Reference</span><span class="p">));</span>
<span class="w">    </span><span class="n">align_ref</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">pdk</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;Alignment Mark&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="n">align_ref</span><span class="o">-&gt;</span><span class="n">repetition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">RepetitionType</span><span class="o">::</span><span class="n">Rectangular</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="mi">500</span><span class="p">,</span><span class="w"> </span><span class="mi">500</span><span class="p">}};</span>
<span class="w">    </span><span class="n">main_cell</span><span class="o">-&gt;</span><span class="n">reference_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">align_ref</span><span class="p">);</span>

<span class="w">    </span><span class="n">Library</span><span class="w"> </span><span class="n">lib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="s">&quot;library&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">unit</span><span class="p">,</span><span class="w"> </span><span class="n">precision</span><span class="p">);</span>
<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">cell_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">main_cell</span><span class="p">);</span>

<span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Cell</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">dependencies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="n">main_cell</span><span class="o">-&gt;</span><span class="n">get_dependencies</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="n">dependencies</span><span class="p">);</span>
<span class="w">    </span><span class="n">dependencies</span><span class="p">.</span><span class="n">to_array</span><span class="p">(</span><span class="n">lib</span><span class="p">.</span><span class="n">cell_array</span><span class="p">);</span>
<span class="w">    </span><span class="n">dependencies</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>

<span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">RawCell</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">raw_dependencies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="n">main_cell</span><span class="o">-&gt;</span><span class="n">get_raw_dependencies</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="n">raw_dependencies</span><span class="p">);</span>
<span class="w">    </span><span class="n">raw_dependencies</span><span class="p">.</span><span class="n">to_array</span><span class="p">(</span><span class="n">lib</span><span class="p">.</span><span class="n">rawcell_array</span><span class="p">);</span>
<span class="w">    </span><span class="n">raw_dependencies</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>

<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">write_gds</span><span class="p">(</span><span class="s">&quot;layout.gds&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">free_all</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Library::free_all does not free RawCells</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">MapItem</span><span class="o">&lt;</span><span class="n">RawCell</span><span class="o">*&gt;*</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pdk</span><span class="p">.</span><span class="n">next</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span><span class="w"> </span><span class="n">item</span><span class="p">;</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pdk</span><span class="p">.</span><span class="n">next</span><span class="p">(</span><span class="n">item</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">item</span><span class="o">-&gt;</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">clear</span><span class="p">();</span>
<span class="w">        </span><span class="n">free_allocation</span><span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">pdk</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<img alt="_images/layout.svg" class="align-center" src="_images/layout.svg" />
</section>
</section>
<section id="merging-libraries">
<h2>Merging Libraries<a class="headerlink" href="#merging-libraries" title="Link to this heading"></a></h2>
<p>Merging two or more libraries is only a matter of adding all the cells from one
into the other.  Extra cells can be latter added, of course, to create new top
level cells with references from both originals.  In this example, we only
merge two GDSII files into a new one—which will end up with 2 top level
cells—and take care of renaming all cells so that they don’t collide.</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--3-input--1" name="tab-set--3" type="radio" /><label class="tab-label" for="tab-set--3-input--1">Python</label><div class="tab-content docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pathlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gdstk</span>


<span class="k">def</span><span class="w"> </span><span class="nf">make_first_lib</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">lib</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Library</span><span class="p">(</span><span class="s2">&quot;First&quot;</span><span class="p">)</span>
    <span class="n">main</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">new_cell</span><span class="p">(</span><span class="s2">&quot;Main&quot;</span><span class="p">)</span>
    <span class="n">main</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">*</span><span class="n">gdstk</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;First library&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
    <span class="n">ref1</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">new_cell</span><span class="p">(</span><span class="s2">&quot;Square&quot;</span><span class="p">)</span>
    <span class="n">ref1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gdstk</span><span class="o">.</span><span class="n">rectangle</span><span class="p">((</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">)))</span>
    <span class="n">main</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gdstk</span><span class="o">.</span><span class="n">Reference</span><span class="p">(</span><span class="n">ref1</span><span class="p">))</span>
    <span class="n">ref2</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">new_cell</span><span class="p">(</span><span class="s2">&quot;Circle&quot;</span><span class="p">)</span>
    <span class="n">ref2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gdstk</span><span class="o">.</span><span class="n">ellipse</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">ref1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gdstk</span><span class="o">.</span><span class="n">Reference</span><span class="p">(</span><span class="n">ref2</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">)))</span>
    <span class="n">lib</span><span class="o">.</span><span class="n">write_gds</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">make_second_lib</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">lib</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Library</span><span class="p">(</span><span class="s2">&quot;Second&quot;</span><span class="p">)</span>
    <span class="n">main</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">new_cell</span><span class="p">(</span><span class="s2">&quot;Main&quot;</span><span class="p">)</span>
    <span class="n">main</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">*</span><span class="n">gdstk</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;Second library&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
    <span class="n">ref</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">new_cell</span><span class="p">(</span><span class="s2">&quot;Circle&quot;</span><span class="p">)</span>
    <span class="n">ref</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gdstk</span><span class="o">.</span><span class="n">ellipse</span><span class="p">((</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">main</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gdstk</span><span class="o">.</span><span class="n">Reference</span><span class="p">(</span><span class="n">ref</span><span class="p">))</span>
    <span class="n">lib</span><span class="o">.</span><span class="n">write_gds</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>

    <span class="c1"># First we create the two libraries we&#39;ll be merging</span>
    <span class="n">make_first_lib</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;lib1.gds&quot;</span><span class="p">)</span>
    <span class="n">make_second_lib</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;lib2.gds&quot;</span><span class="p">)</span>

    <span class="c1"># Now we load the existing libraries</span>
    <span class="n">lib1</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">read_gds</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;lib1.gds&quot;</span><span class="p">)</span>
    <span class="n">lib2</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">read_gds</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;lib2.gds&quot;</span><span class="p">)</span>

    <span class="c1"># We add all cells from the second library to the first</span>
    <span class="n">lib1_cell_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">lib1</span><span class="o">.</span><span class="n">cells</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">lib2</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
        <span class="c1"># We must check that all names are unique within the merged library</span>
        <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">lib1_cell_names</span><span class="p">:</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">name</span> <span class="o">+=</span> <span class="s2">&quot;-lib2&quot;</span>
            <span class="k">assert</span> <span class="n">cell</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lib1_cell_names</span>
        <span class="c1"># Now we add the cell and update the set of names</span>
        <span class="n">lib1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
        <span class="n">lib1_cell_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="n">lib1</span><span class="o">.</span><span class="n">write_gds</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;merging.gds&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--3-input--2" name="tab-set--3" type="radio" /><label class="tab-label" for="tab-set--3-input--2">C++</label><div class="tab-content docutils container">
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;gdstk/gdstk.hpp&gt;</span>

<span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">gdstk</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">make_first_lib</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">filename</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">lib_name</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;First&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">Library</span><span class="w"> </span><span class="n">lib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lib_name</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e-6</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">precision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e-9</span><span class="p">};</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">main_cell_name</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Main&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">Cell</span><span class="w"> </span><span class="n">main_cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">main_cell_name</span><span class="p">};</span>
<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">cell_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">main_cell</span><span class="p">);</span>

<span class="w">    </span><span class="n">Array</span><span class="o">&lt;</span><span class="n">Polygon</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">allocated_polygons</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="n">text</span><span class="p">(</span><span class="s">&quot;First library&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">allocated_polygons</span><span class="p">);</span>
<span class="w">    </span><span class="n">main_cell</span><span class="p">.</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span><span class="n">allocated_polygons</span><span class="p">);</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">square_cell_name</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Square&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">Cell</span><span class="w"> </span><span class="n">square_cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">square_cell_name</span><span class="p">};</span>
<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">cell_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">square_cell</span><span class="p">);</span>

<span class="w">    </span><span class="n">Polygon</span><span class="w"> </span><span class="n">square</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rectangle</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mi">-15</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="mi">-5</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">},</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">square_cell</span><span class="p">.</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">square</span><span class="p">);</span>

<span class="w">    </span><span class="n">Reference</span><span class="w"> </span><span class="n">square_referece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReferenceType</span><span class="o">::</span><span class="n">Cell</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">square_cell</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">magnification</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="n">main_cell</span><span class="p">.</span><span class="n">reference_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">square_referece</span><span class="p">);</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">circle_cell_name</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Circle&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">Cell</span><span class="w"> </span><span class="n">circle_cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">circle_cell_name</span><span class="p">};</span>
<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">cell_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">circle_cell</span><span class="p">);</span>

<span class="w">    </span><span class="n">Polygon</span><span class="w"> </span><span class="n">circle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ellipse</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.01</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">circle_cell</span><span class="p">.</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">circle</span><span class="p">);</span>

<span class="w">    </span><span class="n">Reference</span><span class="w"> </span><span class="n">circle_referece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReferenceType</span><span class="o">::</span><span class="n">Cell</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">circle_cell</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">origin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">-10</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">},</span>
<span class="w">        </span><span class="p">.</span><span class="n">magnification</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="n">square_cell</span><span class="p">.</span><span class="n">reference_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">circle_referece</span><span class="p">);</span>

<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">write_gds</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">cell_array</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">main_cell</span><span class="p">.</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">main_cell</span><span class="p">.</span><span class="n">reference_array</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">square_cell</span><span class="p">.</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">square_cell</span><span class="p">.</span><span class="n">reference_array</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">circle_cell</span><span class="p">.</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">square</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">circle</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">allocated_polygons</span><span class="p">.</span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">allocated_polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">clear</span><span class="p">();</span>
<span class="w">        </span><span class="n">free_allocation</span><span class="p">(</span><span class="n">allocated_polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">allocated_polygons</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">make_second_lib</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">filename</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">lib_name</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Second&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">Library</span><span class="w"> </span><span class="n">lib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lib_name</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e-6</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">precision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e-9</span><span class="p">};</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">main_cell_name</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Main&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">Cell</span><span class="w"> </span><span class="n">main_cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">main_cell_name</span><span class="p">};</span>
<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">cell_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">main_cell</span><span class="p">);</span>

<span class="w">    </span><span class="n">Array</span><span class="o">&lt;</span><span class="n">Polygon</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">allocated_polygons</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="n">text</span><span class="p">(</span><span class="s">&quot;Second library&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">allocated_polygons</span><span class="p">);</span>
<span class="w">    </span><span class="n">main_cell</span><span class="p">.</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span><span class="n">allocated_polygons</span><span class="p">);</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">circle_cell_name</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Circle&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">Cell</span><span class="w"> </span><span class="n">circle_cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">circle_cell_name</span><span class="p">};</span>
<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">cell_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">circle_cell</span><span class="p">);</span>

<span class="w">    </span><span class="n">Polygon</span><span class="w"> </span><span class="n">circle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ellipse</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mi">-10</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">},</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.01</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">circle_cell</span><span class="p">.</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">circle</span><span class="p">);</span>

<span class="w">    </span><span class="n">Reference</span><span class="w"> </span><span class="n">circle_referece</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReferenceType</span><span class="o">::</span><span class="n">Cell</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">circle_cell</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">magnification</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="n">main_cell</span><span class="p">.</span><span class="n">reference_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">circle_referece</span><span class="p">);</span>

<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">write_gds</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">cell_array</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">main_cell</span><span class="p">.</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">main_cell</span><span class="p">.</span><span class="n">reference_array</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">circle_cell</span><span class="p">.</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">circle</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">allocated_polygons</span><span class="p">.</span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">allocated_polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">clear</span><span class="p">();</span>
<span class="w">        </span><span class="n">free_allocation</span><span class="p">(</span><span class="n">allocated_polygons</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">allocated_polygons</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">make_first_lib</span><span class="p">(</span><span class="s">&quot;lib1.gds&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">make_second_lib</span><span class="p">(</span><span class="s">&quot;lib2.gds&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="n">Library</span><span class="w"> </span><span class="n">lib1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_gds</span><span class="p">(</span><span class="s">&quot;lib1.gds&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1e-2</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">Library</span><span class="w"> </span><span class="n">lib2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_gds</span><span class="p">(</span><span class="s">&quot;lib2.gds&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1e-2</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// We could use a hash table to make this more efficient, but we&#39;re aiming</span>
<span class="w">    </span><span class="c1">// for simplicity.</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">lib2</span><span class="p">.</span><span class="n">cell_array</span><span class="p">.</span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Cell</span><span class="o">*</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lib2</span><span class="p">.</span><span class="n">cell_array</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">lib1</span><span class="p">.</span><span class="n">cell_array</span><span class="p">.</span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">lib1</span><span class="p">.</span><span class="n">cell_array</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="w">                </span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">reallocate</span><span class="p">(</span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">6</span><span class="p">);</span>
<span class="w">                </span><span class="n">strcpy</span><span class="p">(</span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-lib2&quot;</span><span class="p">);</span>
<span class="w">                </span><span class="c1">// We should make sure the new name is also unique, but we are</span>
<span class="w">                </span><span class="c1">// skipping that.</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">lib1</span><span class="p">.</span><span class="n">cell_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">lib1</span><span class="p">.</span><span class="n">write_gds</span><span class="p">(</span><span class="s">&quot;merging.gds&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Avoid double-freeing cells from lib2</span>
<span class="w">    </span><span class="n">lib2</span><span class="p">.</span><span class="n">cell_array</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">lib2</span><span class="p">.</span><span class="n">free_all</span><span class="p">();</span>
<span class="w">    </span><span class="n">lib1</span><span class="p">.</span><span class="n">free_all</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="transformations">
<h2>Transformations<a class="headerlink" href="#transformations" title="Link to this heading"></a></h2>
<p>Geometry transformations can be accomplished in several ways.  Individual
polygons or paths can be transformed by their respective methods
(<a class="reference internal" href="geometry/gdstk.Polygon.html#gdstk.Polygon.scale" title="gdstk.Polygon.scale"><code class="xref py py-meth docutils literal notranslate"><span class="pre">gdstk.Polygon.scale()</span></code></a>, <a class="reference internal" href="geometry/gdstk.FlexPath.html#gdstk.FlexPath.rotate" title="gdstk.FlexPath.rotate"><code class="xref py py-meth docutils literal notranslate"><span class="pre">gdstk.FlexPath.rotate()</span></code></a>,
<a class="reference internal" href="geometry/gdstk.RobustPath.html#gdstk.RobustPath.translate" title="gdstk.RobustPath.translate"><code class="xref py py-meth docutils literal notranslate"><span class="pre">gdstk.RobustPath.translate()</span></code></a>, etc.).</p>
<p>In order to transform an entire <a class="reference internal" href="library/gdstk.Cell.html#gdstk.Cell" title="gdstk.Cell"><code class="xref py py-class docutils literal notranslate"><span class="pre">gdstk.Cell</span></code></a>, we can use a
<a class="reference internal" href="library/gdstk.Reference.html#gdstk.Reference" title="gdstk.Reference"><code class="xref py py-class docutils literal notranslate"><span class="pre">gdstk.Reference</span></code></a> with the desired transformation or create a
transformed copy with <a class="reference internal" href="library/gdstk.Cell.html#gdstk.Cell.copy" title="gdstk.Cell.copy"><code class="xref py py-meth docutils literal notranslate"><span class="pre">gdstk.Cell.copy()</span></code></a>.  The former has the advantage of
using less memory, because it does not create actual copies of the geometry or
labels, so it is generally preferable.  The latter is particularly useful when
changes to the transformed cell contents are needed and the original should not
be modified.</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--4-input--1" name="tab-set--4" type="radio" /><label class="tab-label" for="tab-set--4-input--1">Python</label><div class="tab-content docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gdstk</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># Number of unit cells around defect</span>
    <span class="n">d</span> <span class="o">=</span> <span class="mf">0.2</span>  <span class="c1"># Unit cell size</span>
    <span class="n">r</span> <span class="o">=</span> <span class="mf">0.05</span>  <span class="c1"># Circle radius</span>
    <span class="n">s</span> <span class="o">=</span> <span class="mf">1.5</span>  <span class="c1"># Scaling factor</span>

    <span class="c1"># Create a simple unit cell</span>
    <span class="n">unit_cell</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Cell</span><span class="p">(</span><span class="s2">&quot;Unit Cell&quot;</span><span class="p">)</span>
    <span class="n">unit_cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gdstk</span><span class="o">.</span><span class="n">ellipse</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">r</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">))</span>

    <span class="c1"># Build a resonator from a unit cell grid with a defect inside</span>
    <span class="n">ressonator</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Cell</span><span class="p">(</span><span class="s2">&quot;Resonator&quot;</span><span class="p">)</span>
    <span class="n">patches</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">gdstk</span><span class="o">.</span><span class="n">Reference</span><span class="p">(</span>
            <span class="n">unit_cell</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="n">n</span> <span class="o">*</span> <span class="n">d</span><span class="p">,</span> <span class="o">-</span><span class="n">n</span> <span class="o">*</span> <span class="n">d</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="n">gdstk</span><span class="o">.</span><span class="n">Reference</span><span class="p">(</span>
            <span class="n">unit_cell</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="n">n</span> <span class="o">*</span> <span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="n">gdstk</span><span class="o">.</span><span class="n">Reference</span><span class="p">(</span><span class="n">unit_cell</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="n">n</span> <span class="o">*</span> <span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="p">)),</span>
        <span class="n">gdstk</span><span class="o">.</span><span class="n">Reference</span><span class="p">(</span><span class="n">unit_cell</span><span class="p">,</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="p">)),</span>
    <span class="p">]</span>
    <span class="c1"># Defect</span>
    <span class="n">rect</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">rectangle</span><span class="p">((</span><span class="o">-</span><span class="n">r</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="n">r</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">r</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
    <span class="c1"># Path for illustration</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">FlexPath</span><span class="p">(</span>
        <span class="p">[(</span><span class="o">-</span><span class="n">n</span> <span class="o">*</span> <span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">)],</span>
        <span class="n">r</span><span class="p">,</span>
        <span class="n">ends</span><span class="o">=</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="p">),</span>
        <span class="n">simple_path</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">scale_width</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">layer</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ressonator</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">patches</span><span class="p">)</span>

    <span class="c1"># Main output cell with the original resonator,…</span>
    <span class="n">main</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Cell</span><span class="p">(</span><span class="s2">&quot;Main&quot;</span><span class="p">)</span>
    <span class="n">main</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gdstk</span><span class="o">.</span><span class="n">Reference</span><span class="p">(</span><span class="n">ressonator</span><span class="p">))</span>
    <span class="n">main</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">*</span><span class="n">gdstk</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;Original&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">((</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">d</span><span class="p">,</span> <span class="o">-</span><span class="n">d</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)))</span>

    <span class="c1"># … a copy created by scaling a reference to the original resonator,…</span>
    <span class="n">main</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gdstk</span><span class="o">.</span><span class="n">Reference</span><span class="p">(</span><span class="n">ressonator</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">d</span><span class="p">),</span> <span class="n">magnification</span><span class="o">=</span><span class="n">s</span><span class="p">))</span>
    <span class="n">main</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="o">*</span><span class="n">gdstk</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;Reference</span><span class="se">\n</span><span class="s2">scaling&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">d</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">d</span><span class="p">))</span>
    <span class="p">)</span>

    <span class="c1"># … and another copy created by copying and scaling the Cell itself.</span>
    <span class="n">ressonator_copy</span> <span class="o">=</span> <span class="n">ressonator</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="s2">&quot;Resonator Copy&quot;</span><span class="p">,</span> <span class="n">magnification</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
    <span class="n">main</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gdstk</span><span class="o">.</span><span class="n">Reference</span><span class="p">(</span><span class="n">ressonator_copy</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">s</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">d</span><span class="p">)))</span>
    <span class="n">main</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="o">*</span><span class="n">gdstk</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;Cell copy</span><span class="se">\n</span><span class="s2">scaling&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">d</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">s</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">d</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--4-input--2" name="tab-set--4" type="radio" /><label class="tab-label" for="tab-set--4-input--2">C++</label><div class="tab-content docutils container">
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;gdstk/gdstk.hpp&gt;</span>

<span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">gdstk</span><span class="p">;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">lib_name</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;library&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">Library</span><span class="w"> </span><span class="n">lib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lib_name</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e-6</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">precision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e-9</span><span class="p">};</span>

<span class="w">    </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w">    </span><span class="c1">// Unit cells around defect</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.2</span><span class="p">;</span><span class="w">   </span><span class="c1">// Unit cell size</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.05</span><span class="p">;</span><span class="w">  </span><span class="c1">// Circle radius</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.5</span><span class="p">;</span><span class="w">   </span><span class="c1">// Scaling factor</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">unit_cell_name</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Unit Cell&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">Cell</span><span class="w"> </span><span class="n">unit_cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unit_cell_name</span><span class="p">};</span>
<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">cell_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unit_cell</span><span class="p">);</span>

<span class="w">    </span><span class="n">Polygon</span><span class="w"> </span><span class="n">circle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ellipse</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1e-3</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">unit_cell</span><span class="p">.</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">circle</span><span class="p">);</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">resonator_cell_name</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Resonator&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">Cell</span><span class="w"> </span><span class="n">resonator_cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resonator_cell_name</span><span class="p">};</span>
<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">cell_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resonator_cell</span><span class="p">);</span>

<span class="w">    </span><span class="n">Reference</span><span class="w"> </span><span class="n">unit_refs</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReferenceType</span><span class="o">::</span><span class="n">Cell</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">unit_cell</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">origin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="o">-</span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">d</span><span class="p">},</span>
<span class="w">            </span><span class="p">.</span><span class="n">magnification</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">repetition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">RepetitionType</span><span class="o">::</span><span class="n">Rectangular</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">)(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">n</span><span class="p">,</span>
<span class="w">                           </span><span class="n">Vec2</span><span class="p">{</span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">}},</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReferenceType</span><span class="o">::</span><span class="n">Cell</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">unit_cell</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">origin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="o">-</span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">},</span>
<span class="w">            </span><span class="p">.</span><span class="n">magnification</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">repetition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">RepetitionType</span><span class="o">::</span><span class="n">Rectangular</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">)(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">n</span><span class="p">,</span>
<span class="w">                           </span><span class="n">Vec2</span><span class="p">{</span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">}},</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReferenceType</span><span class="o">::</span><span class="n">Cell</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">unit_cell</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">origin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="o">-</span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span>
<span class="w">            </span><span class="p">.</span><span class="n">magnification</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">repetition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">RepetitionType</span><span class="o">::</span><span class="n">Rectangular</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">}},</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReferenceType</span><span class="o">::</span><span class="n">Cell</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">unit_cell</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">origin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span>
<span class="w">            </span><span class="p">.</span><span class="n">magnification</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">repetition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">RepetitionType</span><span class="o">::</span><span class="n">Rectangular</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">}},</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="n">Reference</span><span class="o">*</span><span class="w"> </span><span class="n">unit_refs_p</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">unit_refs</span><span class="p">,</span><span class="w"> </span><span class="n">unit_refs</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">unit_refs</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">unit_refs</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">};</span>
<span class="w">    </span><span class="n">resonator_cell</span><span class="p">.</span><span class="n">reference_array</span><span class="p">.</span><span class="n">extend</span><span class="p">({.</span><span class="n">capacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unit_refs_p</span><span class="p">});</span>

<span class="w">    </span><span class="n">Polygon</span><span class="w"> </span><span class="n">rect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rectangle</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="o">-</span><span class="n">r</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">r</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">},</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="n">r</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">},</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">resonator_cell</span><span class="p">.</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rect</span><span class="p">);</span>

<span class="w">    </span><span class="n">FlexPath</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">simple_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">scale_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="n">path</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="o">-</span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.01</span><span class="p">,</span><span class="w"> </span><span class="n">make_tag</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="w">    </span><span class="n">path</span><span class="p">.</span><span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">end_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EndType</span><span class="o">::</span><span class="n">Extended</span><span class="p">;</span>
<span class="w">    </span><span class="n">path</span><span class="p">.</span><span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">end_extensions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">};</span>
<span class="w">    </span><span class="n">path</span><span class="p">.</span><span class="n">segment</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="w">    </span><span class="n">resonator_cell</span><span class="p">.</span><span class="n">flexpath_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">main_cell_name</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Main&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">Cell</span><span class="w"> </span><span class="n">main_cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">main_cell_name</span><span class="p">};</span>
<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">cell_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">main_cell</span><span class="p">);</span>

<span class="w">    </span><span class="n">Cell</span><span class="w"> </span><span class="n">resonator_cell_copy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">cell_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resonator_cell_copy</span><span class="p">);</span>
<span class="w">    </span><span class="n">resonator_cell_copy</span><span class="p">.</span><span class="n">copy_from</span><span class="p">(</span><span class="n">resonator_cell</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Resonator Copy&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int64_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">resonator_cell_copy</span><span class="p">.</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Polygon</span><span class="o">*</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resonator_cell_copy</span><span class="p">.</span><span class="n">polygon_array</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">        </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">scale</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">},</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int64_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">resonator_cell_copy</span><span class="p">.</span><span class="n">flexpath_array</span><span class="p">.</span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">FlexPath</span><span class="o">*</span><span class="w"> </span><span class="n">fp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resonator_cell_copy</span><span class="p">.</span><span class="n">flexpath_array</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">        </span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">scale</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int64_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">resonator_cell_copy</span><span class="p">.</span><span class="n">robustpath_array</span><span class="p">.</span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">RobustPath</span><span class="o">*</span><span class="w"> </span><span class="n">rp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resonator_cell_copy</span><span class="p">.</span><span class="n">robustpath_array</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">        </span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">scale</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int64_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">resonator_cell_copy</span><span class="p">.</span><span class="n">reference_array</span><span class="p">.</span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Reference</span><span class="o">*</span><span class="w"> </span><span class="n">ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resonator_cell_copy</span><span class="p">.</span><span class="n">reference_array</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">        </span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">transform</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">});</span>
<span class="w">        </span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">repetition</span><span class="p">.</span><span class="n">transform</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">Reference</span><span class="w"> </span><span class="n">resonator_refs</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReferenceType</span><span class="o">::</span><span class="n">Cell</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">resonator_cell</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">magnification</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReferenceType</span><span class="o">::</span><span class="n">Cell</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">resonator_cell</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">origin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">d</span><span class="p">},</span>
<span class="w">            </span><span class="p">.</span><span class="n">magnification</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReferenceType</span><span class="o">::</span><span class="n">Cell</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">resonator_cell_copy</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">origin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">d</span><span class="p">},</span>
<span class="w">            </span><span class="p">.</span><span class="n">magnification</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="n">Reference</span><span class="o">*</span><span class="w"> </span><span class="n">resonator_refs_p</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">resonator_refs</span><span class="p">,</span><span class="w"> </span><span class="n">resonator_refs</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">resonator_refs</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">};</span>
<span class="w">    </span><span class="n">main_cell</span><span class="p">.</span><span class="n">reference_array</span><span class="p">.</span><span class="n">extend</span><span class="p">({.</span><span class="n">capacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resonator_refs_p</span><span class="p">});</span>

<span class="w">    </span><span class="n">Array</span><span class="o">&lt;</span><span class="n">Polygon</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">all_text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="n">text</span><span class="p">(</span><span class="s">&quot;Original&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{(</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">},</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">all_text</span><span class="p">);</span>
<span class="w">    </span><span class="n">text</span><span class="p">(</span><span class="s">&quot;Reference</span><span class="se">\n</span><span class="s">scaling&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="n">s</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">d</span><span class="p">},</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">all_text</span><span class="p">);</span>
<span class="w">    </span><span class="n">text</span><span class="p">(</span><span class="s">&quot;Cell copy</span><span class="se">\n</span><span class="s">scaling&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="n">s</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">d</span><span class="p">},</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">         </span><span class="n">all_text</span><span class="p">);</span>
<span class="w">    </span><span class="n">main_cell</span><span class="p">.</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span><span class="n">all_text</span><span class="p">);</span>

<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">write_gds</span><span class="p">(</span><span class="s">&quot;transforms.gds&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">all_text</span><span class="p">.</span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">all_text</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">clear</span><span class="p">();</span>
<span class="w">        </span><span class="n">free_allocation</span><span class="p">(</span><span class="n">all_text</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">all_text</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">circle</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">rect</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">path</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">unit_cell</span><span class="p">.</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">resonator_cell</span><span class="p">.</span><span class="n">reference_array</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">resonator_cell</span><span class="p">.</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">resonator_cell</span><span class="p">.</span><span class="n">flexpath_array</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">resonator_cell_copy</span><span class="p">.</span><span class="n">free_all</span><span class="p">();</span>
<span class="w">    </span><span class="n">main_cell</span><span class="p">.</span><span class="n">reference_array</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">main_cell</span><span class="p">.</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">cell_array</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<img alt="_images/transforms.svg" class="align-center" src="_images/transforms.svg" />
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The SVG output does not support the <cite>scale_width</cite> attribute of paths, that
is why the width of the path in the referencer-scaled version of the
geometry is wider that the original.  When using <a class="reference internal" href="library/gdstk.Cell.html#gdstk.Cell.copy" title="gdstk.Cell.copy"><code class="xref py py-meth docutils literal notranslate"><span class="pre">gdstk.Cell.copy()</span></code></a>,
the attribute is respected.  This is also a problem for some GDSII viewers
and editors.</p>
</div>
</section>
<section id="repetitions">
<h2>Repetitions<a class="headerlink" href="#repetitions" title="Link to this heading"></a></h2>
<p>References can be effectively used to instantiate repetitive geometry across a
layout.  <code class="xref py py-class docutils literal notranslate"><span class="pre">Repetition</span></code> is an extension of that idea which allows the
reuse of any element without the need for creating a <a class="reference internal" href="library/gdstk.Cell.html#gdstk.Cell" title="gdstk.Cell"><code class="xref py py-class docutils literal notranslate"><span class="pre">gdstk.Cell</span></code></a>.  In
fact, the creation of a <a class="reference internal" href="library/gdstk.Reference.html#gdstk.Reference" title="gdstk.Reference"><code class="xref py py-class docutils literal notranslate"><span class="pre">gdstk.Reference</span></code></a> as an array is only a shortcut
to the creation of a single reference with a rectangular (or regular)
repetition.  The following example demonstrates the use of different forms of
repetition to avoid creating all objects in memory (the final GDSII file will
contain all copies).</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--5-input--1" name="tab-set--5" type="radio" /><label class="tab-label" for="tab-set--5-input--1">Python</label><div class="tab-content docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gdstk</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># Rectangular repetition</span>
    <span class="n">square</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">regular_polygon</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">square</span><span class="o">.</span><span class="n">repetition</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Repetition</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Regular repetition</span>
    <span class="n">triangle</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">regular_polygon</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">triangle</span><span class="o">.</span><span class="n">repetition</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Repetition</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">v1</span><span class="o">=</span><span class="p">(</span><span class="mf">0.4</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">),</span> <span class="n">v2</span><span class="o">=</span><span class="p">(</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">))</span>

    <span class="c1"># Explicit repetition</span>
    <span class="n">circle</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">ellipse</span><span class="p">((</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="n">circle</span><span class="o">.</span><span class="n">repetition</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Repetition</span><span class="p">(</span><span class="n">offsets</span><span class="o">=</span><span class="p">[(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)])</span>

    <span class="c1"># X-explicit repetition</span>
    <span class="n">vline</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">FlexPath</span><span class="p">([(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">)],</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">simple_path</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">vline</span><span class="o">.</span><span class="n">repetition</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Repetition</span><span class="p">(</span><span class="n">x_offsets</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">])</span>

    <span class="c1"># Y-explicit repetition</span>
    <span class="n">hline</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">RobustPath</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">simple_path</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">hline</span><span class="o">.</span><span class="n">segment</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">hline</span><span class="o">.</span><span class="n">repetition</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Repetition</span><span class="p">(</span><span class="n">y_offsets</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">])</span>

    <span class="n">main</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Cell</span><span class="p">(</span><span class="s2">&quot;Main&quot;</span><span class="p">)</span>
    <span class="n">main</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">square</span><span class="p">,</span> <span class="n">triangle</span><span class="p">,</span> <span class="n">circle</span><span class="p">,</span> <span class="n">vline</span><span class="p">,</span> <span class="n">hline</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--5-input--2" name="tab-set--5" type="radio" /><label class="tab-label" for="tab-set--5-input--2">C++</label><div class="tab-content docutils container">
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;gdstk/gdstk.hpp&gt;</span>

<span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">gdstk</span><span class="p">;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">lib_name</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;library&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">Library</span><span class="w"> </span><span class="n">lib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lib_name</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e-6</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">precision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e-9</span><span class="p">};</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">main_cell_name</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Main&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">Cell</span><span class="w"> </span><span class="n">main_cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">main_cell_name</span><span class="p">};</span>
<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">cell_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">main_cell</span><span class="p">);</span>

<span class="w">    </span><span class="n">Polygon</span><span class="w"> </span><span class="n">square</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regular_polygon</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span><span class="w"> </span><span class="mf">0.2</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">square</span><span class="p">.</span><span class="n">repetition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">RepetitionType</span><span class="o">::</span><span class="n">Rectangular</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">}};</span>
<span class="w">    </span><span class="n">main_cell</span><span class="p">.</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">square</span><span class="p">);</span>

<span class="w">    </span><span class="n">Polygon</span><span class="w"> </span><span class="n">triangle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regular_polygon</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">2.5</span><span class="p">},</span><span class="w"> </span><span class="mf">0.2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">triangle</span><span class="p">.</span><span class="n">repetition</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RepetitionType</span><span class="o">::</span><span class="n">Regular</span><span class="p">;</span>
<span class="w">    </span><span class="n">triangle</span><span class="p">.</span><span class="n">repetition</span><span class="p">.</span><span class="n">columns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">    </span><span class="n">triangle</span><span class="p">.</span><span class="n">repetition</span><span class="p">.</span><span class="n">rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="w">    </span><span class="n">triangle</span><span class="p">.</span><span class="n">repetition</span><span class="p">.</span><span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="mf">0.4</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.3</span><span class="p">};</span>
<span class="w">    </span><span class="n">triangle</span><span class="p">.</span><span class="n">repetition</span><span class="p">.</span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="mf">0.4</span><span class="p">,</span><span class="w"> </span><span class="mf">0.2</span><span class="p">};</span>
<span class="w">    </span><span class="n">main_cell</span><span class="p">.</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">triangle</span><span class="p">);</span>

<span class="w">    </span><span class="n">Polygon</span><span class="w"> </span><span class="n">circle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ellipse</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mf">3.5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span><span class="w"> </span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.01</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">Vec2</span><span class="w"> </span><span class="n">offsets</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mf">1.5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">}};</span>
<span class="w">    </span><span class="n">circle</span><span class="p">.</span><span class="n">repetition</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RepetitionType</span><span class="o">::</span><span class="n">Explicit</span><span class="p">;</span>
<span class="w">    </span><span class="n">circle</span><span class="p">.</span><span class="n">repetition</span><span class="p">.</span><span class="n">offsets</span><span class="p">.</span><span class="n">extend</span><span class="p">({.</span><span class="n">capacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">COUNT</span><span class="p">(</span><span class="n">offsets</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">offsets</span><span class="p">});</span>
<span class="w">    </span><span class="n">main_cell</span><span class="p">.</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">circle</span><span class="p">);</span>

<span class="w">    </span><span class="n">FlexPath</span><span class="w"> </span><span class="n">vline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="n">vline</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">},</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.01</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">vline</span><span class="p">.</span><span class="n">simple_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="n">vline</span><span class="p">.</span><span class="n">segment</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mf">3.5</span><span class="p">},</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">vcoords</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">0.2</span><span class="p">,</span><span class="w"> </span><span class="mf">0.6</span><span class="p">,</span><span class="w"> </span><span class="mf">1.4</span><span class="p">,</span><span class="w"> </span><span class="mf">3.0</span><span class="p">};</span>
<span class="w">    </span><span class="n">vline</span><span class="p">.</span><span class="n">repetition</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RepetitionType</span><span class="o">::</span><span class="n">ExplicitX</span><span class="p">;</span>
<span class="w">    </span><span class="n">vline</span><span class="p">.</span><span class="n">repetition</span><span class="p">.</span><span class="n">coords</span><span class="p">.</span><span class="n">extend</span><span class="p">({.</span><span class="n">capacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">COUNT</span><span class="p">(</span><span class="n">vcoords</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vcoords</span><span class="p">});</span>
<span class="w">    </span><span class="n">main_cell</span><span class="p">.</span><span class="n">flexpath_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vline</span><span class="p">);</span>

<span class="w">    </span><span class="n">RobustPath</span><span class="w"> </span><span class="n">hline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="n">hline</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">},</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mf">0.05</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.01</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">hline</span><span class="p">.</span><span class="n">simple_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="n">hline</span><span class="p">.</span><span class="n">segment</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">},</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">hcoords</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="mf">0.3</span><span class="p">,</span><span class="w"> </span><span class="mf">0.7</span><span class="p">,</span><span class="w"> </span><span class="mf">1.5</span><span class="p">};</span>
<span class="w">    </span><span class="n">hline</span><span class="p">.</span><span class="n">repetition</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RepetitionType</span><span class="o">::</span><span class="n">ExplicitY</span><span class="p">;</span>
<span class="w">    </span><span class="n">hline</span><span class="p">.</span><span class="n">repetition</span><span class="p">.</span><span class="n">coords</span><span class="p">.</span><span class="n">extend</span><span class="p">({.</span><span class="n">capacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">COUNT</span><span class="p">(</span><span class="n">hcoords</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hcoords</span><span class="p">});</span>
<span class="w">    </span><span class="n">main_cell</span><span class="p">.</span><span class="n">robustpath_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hline</span><span class="p">);</span>

<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">write_gds</span><span class="p">(</span><span class="s">&quot;repetitions.gds&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="n">square</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">triangle</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">circle</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">vline</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">hline</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">main_cell</span><span class="p">.</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">main_cell</span><span class="p">.</span><span class="n">flexpath_array</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">main_cell</span><span class="p">.</span><span class="n">robustpath_array</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">cell_array</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<img alt="_images/repetitions.svg" class="align-center" src="_images/repetitions.svg" />
<p>When geometry operations are applied to elements with repetitions, they are not
automatically applied.  If desired the repetition can be manually applied
before executing the desired operation.  The following example demonstrates
this use:</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--6-input--1" name="tab-set--6" type="radio" /><label class="tab-label" for="tab-set--6-input--1">Python</label><div class="tab-content docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gdstk</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># X-explicit repetition</span>
    <span class="n">vline</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">FlexPath</span><span class="p">([(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">)],</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">simple_path</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">vline</span><span class="o">.</span><span class="n">repetition</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Repetition</span><span class="p">(</span><span class="n">x_offsets</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">])</span>

    <span class="c1"># Y-explicit repetition</span>
    <span class="n">hline</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">RobustPath</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">simple_path</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">hline</span><span class="o">.</span><span class="n">segment</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">hline</span><span class="o">.</span><span class="n">repetition</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Repetition</span><span class="p">(</span><span class="n">y_offsets</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">])</span>

    <span class="c1"># Create all copies</span>
    <span class="n">vlines</span> <span class="o">=</span> <span class="n">vline</span><span class="o">.</span><span class="n">apply_repetition</span><span class="p">()</span>
    <span class="n">hlines</span> <span class="o">=</span> <span class="n">hline</span><span class="o">.</span><span class="n">apply_repetition</span><span class="p">()</span>

    <span class="c1"># Include original elements for boolean operation</span>
    <span class="n">vlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vline</span><span class="p">)</span>
    <span class="n">hlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hline</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">boolean</span><span class="p">(</span><span class="n">vlines</span><span class="p">,</span> <span class="n">hlines</span><span class="p">,</span> <span class="s2">&quot;or&quot;</span><span class="p">)</span>

    <span class="n">main</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Cell</span><span class="p">(</span><span class="s2">&quot;Main&quot;</span><span class="p">)</span>
    <span class="n">main</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">*</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--6-input--2" name="tab-set--6" type="radio" /><label class="tab-label" for="tab-set--6-input--2">C++</label><div class="tab-content docutils container">
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;gdstk/gdstk.hpp&gt;</span>

<span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">gdstk</span><span class="p">;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Library</span><span class="w"> </span><span class="n">lib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="s">&quot;library&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">1e-6</span><span class="p">,</span><span class="w"> </span><span class="mf">1e-9</span><span class="p">);</span>

<span class="w">    </span><span class="n">Cell</span><span class="w"> </span><span class="n">main_cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="n">main_cell</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">copy_string</span><span class="p">(</span><span class="s">&quot;Main&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">cell_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">main_cell</span><span class="p">);</span>

<span class="w">    </span><span class="n">FlexPath</span><span class="w"> </span><span class="n">vline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="n">vline</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">},</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.01</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">vline</span><span class="p">.</span><span class="n">simple_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="n">vline</span><span class="p">.</span><span class="n">segment</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mf">3.5</span><span class="p">},</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">vcoords</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">0.2</span><span class="p">,</span><span class="w"> </span><span class="mf">0.6</span><span class="p">,</span><span class="w"> </span><span class="mf">1.4</span><span class="p">,</span><span class="w"> </span><span class="mf">3.0</span><span class="p">};</span>
<span class="w">    </span><span class="n">vline</span><span class="p">.</span><span class="n">repetition</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RepetitionType</span><span class="o">::</span><span class="n">ExplicitX</span><span class="p">;</span>
<span class="w">    </span><span class="n">vline</span><span class="p">.</span><span class="n">repetition</span><span class="p">.</span><span class="n">coords</span><span class="p">.</span><span class="n">extend</span><span class="p">({.</span><span class="n">capacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">COUNT</span><span class="p">(</span><span class="n">vcoords</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vcoords</span><span class="p">});</span>

<span class="w">    </span><span class="n">Array</span><span class="o">&lt;</span><span class="n">Polygon</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">vlines</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="n">vline</span><span class="p">.</span><span class="n">to_polygons</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">vlines</span><span class="p">);</span>
<span class="w">    </span><span class="n">vline</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Because we know there is only a single resulting polygon we dont need to</span>
<span class="w">    </span><span class="c1">// loop here.</span>
<span class="w">    </span><span class="n">vlines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">apply_repetition</span><span class="p">(</span><span class="n">vlines</span><span class="p">);</span>

<span class="w">    </span><span class="n">RobustPath</span><span class="w"> </span><span class="n">hline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="n">hline</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">},</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mf">0.05</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.01</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">hline</span><span class="p">.</span><span class="n">simple_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="n">hline</span><span class="p">.</span><span class="n">segment</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">},</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">hcoords</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="mf">0.3</span><span class="p">,</span><span class="w"> </span><span class="mf">0.7</span><span class="p">,</span><span class="w"> </span><span class="mf">1.5</span><span class="p">};</span>
<span class="w">    </span><span class="n">hline</span><span class="p">.</span><span class="n">repetition</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RepetitionType</span><span class="o">::</span><span class="n">ExplicitY</span><span class="p">;</span>
<span class="w">    </span><span class="n">hline</span><span class="p">.</span><span class="n">repetition</span><span class="p">.</span><span class="n">coords</span><span class="p">.</span><span class="n">extend</span><span class="p">({.</span><span class="n">capacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">COUNT</span><span class="p">(</span><span class="n">hcoords</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hcoords</span><span class="p">});</span>

<span class="w">    </span><span class="n">Array</span><span class="o">&lt;</span><span class="n">Polygon</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">hlines</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="n">hline</span><span class="p">.</span><span class="n">to_polygons</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">hlines</span><span class="p">);</span>
<span class="w">    </span><span class="n">hline</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Once again, no loop needed.</span>
<span class="w">    </span><span class="n">hlines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">apply_repetition</span><span class="p">(</span><span class="n">vlines</span><span class="p">);</span>

<span class="w">    </span><span class="n">Array</span><span class="o">&lt;</span><span class="n">Polygon</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="n">boolean</span><span class="p">(</span><span class="n">vlines</span><span class="p">,</span><span class="w"> </span><span class="n">hlines</span><span class="p">,</span><span class="w"> </span><span class="n">Operation</span><span class="o">::</span><span class="n">Or</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">vlines</span><span class="p">.</span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">vlines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">clear</span><span class="p">();</span>
<span class="w">        </span><span class="n">free_allocation</span><span class="p">(</span><span class="n">vlines</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">vlines</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">hlines</span><span class="p">.</span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">hlines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">clear</span><span class="p">();</span>
<span class="w">        </span><span class="n">free_allocation</span><span class="p">(</span><span class="n">hlines</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">hlines</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>

<span class="w">    </span><span class="n">main_cell</span><span class="p">.</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>

<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">write_gds</span><span class="p">(</span><span class="s">&quot;apply_repetition.gds&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">main_cell</span><span class="p">.</span><span class="n">free_all</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<img alt="_images/apply_repetition.svg" class="align-center" src="_images/apply_repetition.svg" />
</section>
<section id="geometry-filtering">
<h2>Geometry Filtering<a class="headerlink" href="#geometry-filtering" title="Link to this heading"></a></h2>
<p>Filtering the geometry of a loaded library requires only iterating over the
desired cells and objects, testing and removing those not wanted.  In this
example we load the layout created in <a class="reference internal" href="#using-a-library"><span class="std std-ref">Using a Library</span></a> and remove the
polygons in layer 2 (grating teeth) and paths in layer 10 (in the MZI).</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--7-input--1" name="tab-set--7" type="radio" /><label class="tab-label" for="tab-set--7-input--1">Python</label><div class="tab-content docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pathlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gdstk</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>

    <span class="c1"># Load existing library</span>
    <span class="n">lib</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">read_gds</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;layout.gds&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
        <span class="c1"># Remove any polygons in layer 2</span>
        <span class="n">cell</span><span class="o">.</span><span class="n">filter</span><span class="p">([(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)],</span> <span class="n">paths</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Remove any paths in layer 10</span>
        <span class="n">cell</span><span class="o">.</span><span class="n">filter</span><span class="p">([(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">)],</span> <span class="n">polygons</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">lib</span><span class="o">.</span><span class="n">write_gds</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;filtered-layout.gds&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--7-input--2" name="tab-set--7" type="radio" /><label class="tab-label" for="tab-set--7-input--2">C++</label><div class="tab-content docutils container">
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;gdstk/gdstk.hpp&gt;</span>

<span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">gdstk</span><span class="p">;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ErrorCode</span><span class="w"> </span><span class="n">error_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ErrorCode</span><span class="o">::</span><span class="n">NoError</span><span class="p">;</span>
<span class="w">    </span><span class="n">Library</span><span class="w"> </span><span class="n">lib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_gds</span><span class="p">(</span><span class="s">&quot;layout.gds&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1e-2</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error_code</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error_code</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ErrorCode</span><span class="o">::</span><span class="n">NoError</span><span class="p">)</span><span class="w"> </span><span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int64_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">lib</span><span class="p">.</span><span class="n">cell_array</span><span class="p">.</span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Cell</span><span class="o">*</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lib</span><span class="p">.</span><span class="n">cell_array</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int64_t</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Polygon</span><span class="o">*</span><span class="w"> </span><span class="n">poly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">polygon_array</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
<span class="w">            </span><span class="c1">// Decrement j so that we don&#39;t skip over the next polygon.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">get_layer</span><span class="p">(</span><span class="n">poly</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">j</span><span class="o">--</span><span class="p">);</span>
<span class="w">                </span><span class="n">poly</span><span class="o">-&gt;</span><span class="n">clear</span><span class="p">();</span>
<span class="w">                </span><span class="n">free_allocation</span><span class="p">(</span><span class="n">poly</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">// Loaded libraries have no RobustPath elements</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int64_t</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">flexpath_array</span><span class="p">.</span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">FlexPath</span><span class="o">*</span><span class="w"> </span><span class="n">fp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">flexpath_array</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
<span class="w">            </span><span class="c1">// All paths in loaded libraries have only 1 element.</span>
<span class="w">            </span><span class="c1">// Decrement j so that we don&#39;t skip over the next path.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">get_layer</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tag</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">flexpath_array</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">j</span><span class="o">--</span><span class="p">);</span>
<span class="w">                </span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">clear</span><span class="p">();</span>
<span class="w">                </span><span class="n">free_allocation</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">write_gds</span><span class="p">(</span><span class="s">&quot;filtered-layout.gds&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">free_all</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<img alt="_images/filtering.svg" class="align-center" src="_images/filtering.svg" />
<p>Another common use of filtering is to remove geometry in a particular region.
In this example we create a periodic background and remove all elements that
overlap a particular shape using <a class="reference internal" href="geometry/gdstk.inside.html#gdstk.inside" title="gdstk.inside"><code class="xref py py-func docutils literal notranslate"><span class="pre">gdstk.inside()</span></code></a> to test.</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--8-input--1" name="tab-set--8" type="radio" /><label class="tab-label" for="tab-set--8-input--1">Python</label><div class="tab-content docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pathlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gdstk</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>

    <span class="n">unit</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Cell</span><span class="p">(</span><span class="s2">&quot;Unit&quot;</span><span class="p">)</span>
    <span class="n">unit</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gdstk</span><span class="o">.</span><span class="n">cross</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">))</span>

    <span class="n">main</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Cell</span><span class="p">(</span><span class="s2">&quot;Main&quot;</span><span class="p">)</span>

    <span class="c1"># Create repeating pattern using references</span>
    <span class="n">d</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">ref1</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Reference</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span> <span class="mi">3</span><span class="o">**</span><span class="mf">0.5</span><span class="p">))</span>
    <span class="n">ref2</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Reference</span><span class="p">(</span>
        <span class="n">unit</span><span class="p">,</span> <span class="p">(</span><span class="n">d</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span> <span class="mi">3</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span> <span class="mi">3</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">main</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ref1</span><span class="p">,</span> <span class="n">ref2</span><span class="p">)</span>
    <span class="n">main</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="n">hole</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;PY&quot;</span><span class="p">,</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">d</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">layer</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="n">main</span><span class="o">.</span><span class="n">polygons</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">any_inside</span><span class="p">(</span><span class="n">pol</span><span class="o">.</span><span class="n">points</span><span class="p">,</span> <span class="n">hole</span><span class="p">):</span>
            <span class="n">main</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pol</span><span class="p">)</span>

    <span class="n">main</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">*</span><span class="n">hole</span><span class="p">)</span>

    <span class="n">gdstk</span><span class="o">.</span><span class="n">Library</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">.</span><span class="n">write_gds</span><span class="p">(</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;pos_filtering.gds&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--8-input--2" name="tab-set--8" type="radio" /><label class="tab-label" for="tab-set--8-input--2">C++</label><div class="tab-content docutils container">
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;gdstk/gdstk.hpp&gt;</span>

<span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">gdstk</span><span class="p">;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">lib_name</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;library&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">Library</span><span class="w"> </span><span class="n">lib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lib_name</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e-6</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">precision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e-9</span><span class="p">};</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">unit_cell_name</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Unit&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">Cell</span><span class="w"> </span><span class="n">unit_cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unit_cell_name</span><span class="p">};</span>

<span class="w">    </span><span class="n">Polygon</span><span class="w"> </span><span class="n">cross_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cross</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mf">0.2</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">unit_cell</span><span class="p">.</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cross_</span><span class="p">);</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">main_cell_name</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Main&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">Cell</span><span class="w"> </span><span class="n">main_cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">main_cell_name</span><span class="p">};</span>
<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">cell_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">&amp;</span><span class="n">main_cell</span><span class="p">);</span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="n">Reference</span><span class="w"> </span><span class="n">unit_refs</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReferenceType</span><span class="o">::</span><span class="n">Cell</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">unit_cell</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">magnification</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">repetition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">RepetitionType</span><span class="o">::</span><span class="n">Rectangular</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)}},</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReferenceType</span><span class="o">::</span><span class="n">Cell</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">unit_cell</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">origin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="n">d</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">},</span>
<span class="w">            </span><span class="p">.</span><span class="n">magnification</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">repetition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">RepetitionType</span><span class="o">::</span><span class="n">Rectangular</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)}},</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="n">main_cell</span><span class="p">.</span><span class="n">reference_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit_refs</span><span class="p">);</span>
<span class="w">    </span><span class="n">main_cell</span><span class="p">.</span><span class="n">reference_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit_refs</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">    </span><span class="n">Array</span><span class="o">&lt;</span><span class="n">Reference</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">removed_references</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="n">main_cell</span><span class="p">.</span><span class="n">flatten</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="n">removed_references</span><span class="p">);</span>
<span class="w">    </span><span class="n">removed_references</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>

<span class="w">    </span><span class="n">Array</span><span class="o">&lt;</span><span class="n">Polygon</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">txt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="n">text</span><span class="p">(</span><span class="s">&quot;PY&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="mf">0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">make_tag</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">txt</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">main_cell</span><span class="p">.</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Polygon</span><span class="o">*</span><span class="w"> </span><span class="n">poly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">main_cell</span><span class="p">.</span><span class="n">polygon_array</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">any_inside</span><span class="p">(</span><span class="n">poly</span><span class="o">-&gt;</span><span class="n">point_array</span><span class="p">,</span><span class="w"> </span><span class="n">txt</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">poly</span><span class="o">-&gt;</span><span class="n">clear</span><span class="p">();</span>
<span class="w">            </span><span class="n">free_allocation</span><span class="p">(</span><span class="n">poly</span><span class="p">);</span>
<span class="w">            </span><span class="n">main_cell</span><span class="p">.</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">main_cell</span><span class="p">.</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span><span class="n">txt</span><span class="p">);</span>
<span class="w">    </span><span class="n">txt</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>

<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">write_gds</span><span class="p">(</span><span class="s">&quot;pos_filtering.gds&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="n">cross_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">main_cell</span><span class="p">.</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">main_cell</span><span class="p">.</span><span class="n">polygon_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">clear</span><span class="p">();</span>
<span class="w">        </span><span class="n">free_allocation</span><span class="p">(</span><span class="n">main_cell</span><span class="p">.</span><span class="n">polygon_array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">main_cell</span><span class="p">.</span><span class="n">reference_array</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">main_cell</span><span class="p">.</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">unit_cell</span><span class="p">.</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">cell_array</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<img alt="_images/pos_filtering.svg" class="align-center" src="_images/pos_filtering.svg" />
<p>Finally, <a class="reference internal" href="library/gdstk.read_gds.html#gdstk.read_gds" title="gdstk.read_gds"><code class="xref py py-func docutils literal notranslate"><span class="pre">gdstk.read_gds()</span></code></a> provides a way to only load specific layers and
data types from a GDSII file, and methods <a class="reference internal" href="library/gdstk.Cell.html#gdstk.Cell.get_polygons" title="gdstk.Cell.get_polygons"><code class="xref py py-meth docutils literal notranslate"><span class="pre">gdstk.Cell.get_polygons()</span></code></a>,
<a class="reference internal" href="library/gdstk.Cell.html#gdstk.Cell.get_paths" title="gdstk.Cell.get_paths"><code class="xref py py-meth docutils literal notranslate"><span class="pre">gdstk.Cell.get_paths()</span></code></a>, <a class="reference internal" href="library/gdstk.Cell.html#gdstk.Cell.get_labels" title="gdstk.Cell.get_labels"><code class="xref py py-meth docutils literal notranslate"><span class="pre">gdstk.Cell.get_labels()</span></code></a> can also be used to
gather elements only from specific layers and types.</p>
</section>
<section id="points-along-a-path">
<h2>Points Along a Path<a class="headerlink" href="#points-along-a-path" title="Link to this heading"></a></h2>
<p>The following example shows how to add markers along a
<a class="reference internal" href="geometry/gdstk.RobustPath.html#gdstk.RobustPath" title="gdstk.RobustPath"><code class="xref py py-class docutils literal notranslate"><span class="pre">gdstk.RobustPath</span></code></a>.  It uses the original parameterization of the path
to locate the markers, following the construction sections.  Markers positioned
at a fixed distance must be calculated for each section independently.</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--9-input--1" name="tab-set--9" type="radio" /><label class="tab-label" for="tab-set--9-input--1">Python</label><div class="tab-content docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gdstk</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Cell</span><span class="p">(</span><span class="s2">&quot;Main&quot;</span><span class="p">)</span>

    <span class="c1"># Create a path</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">RobustPath</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">path</span><span class="o">.</span><span class="n">segment</span><span class="p">((</span><span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">path</span><span class="o">.</span><span class="n">interpolation</span><span class="p">(</span>
        <span class="p">[(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">12</span><span class="p">)],</span>
        <span class="n">angles</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span><span class="p">],</span>
        <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">path</span><span class="o">.</span><span class="n">segment</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">),</span> <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">main</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="c1"># Major and minor markers</span>
    <span class="n">major</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">regular_polygon</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">minor</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">rectangle</span><span class="p">((</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">layer</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
        <span class="c1"># A major marker is added at the start of each path section</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">major</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">m</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">position</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
        <span class="n">main</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="c1"># Each section receives 3 equally-spaced minor markers</span>
            <span class="c1"># rotated to be aligned to the path direction</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">minor</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">grad</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">u</span><span class="p">)</span>
            <span class="n">m</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">grad</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">grad</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">m</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">position</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">u</span><span class="p">))</span>
            <span class="n">main</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="c1"># Add a major marker at the end of the path</span>
    <span class="n">major</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">position</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
    <span class="n">main</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">major</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--9-input--2" name="tab-set--9" type="radio" /><label class="tab-label" for="tab-set--9-input--2">C++</label><div class="tab-content docutils container">
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;gdstk/gdstk.hpp&gt;</span>

<span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">gdstk</span><span class="p">;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Library</span><span class="w"> </span><span class="n">lib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="s">&quot;library&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">1e-6</span><span class="p">,</span><span class="w"> </span><span class="mf">1e-9</span><span class="p">);</span>

<span class="w">    </span><span class="n">Cell</span><span class="o">*</span><span class="w"> </span><span class="n">main_cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Cell</span><span class="o">*</span><span class="p">)</span><span class="n">allocate_clear</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Cell</span><span class="p">));</span>
<span class="w">    </span><span class="n">main_cell</span><span class="o">-&gt;</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">copy_string</span><span class="p">(</span><span class="s">&quot;Main&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">cell_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">main_cell</span><span class="p">);</span>

<span class="w">    </span><span class="n">RobustPath</span><span class="o">*</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">RobustPath</span><span class="o">*</span><span class="p">)</span><span class="n">allocate_clear</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">RobustPath</span><span class="p">));</span>
<span class="w">    </span><span class="n">path</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.01</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">path</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>

<span class="w">    </span><span class="n">Vec2</span><span class="w"> </span><span class="n">points</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">-4</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mi">-2</span><span class="p">,</span><span class="w"> </span><span class="mi">-6</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mi">-5</span><span class="p">,</span><span class="w"> </span><span class="mi">-8</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mi">-4</span><span class="p">,</span><span class="w"> </span><span class="mi">-12</span><span class="p">}};</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">angles</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">M_PI</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">4</span><span class="p">};</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">angle_constraints</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">};</span>
<span class="w">    </span><span class="n">Vec2</span><span class="w"> </span><span class="n">tension</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">}};</span>
<span class="w">    </span><span class="n">path</span><span class="o">-&gt;</span><span class="n">interpolation</span><span class="p">({.</span><span class="n">capacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">COUNT</span><span class="p">(</span><span class="n">points</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">points</span><span class="p">},</span><span class="w"> </span><span class="n">angles</span><span class="p">,</span>
<span class="w">                        </span><span class="n">angle_constraints</span><span class="p">,</span><span class="w"> </span><span class="n">tension</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>

<span class="w">    </span><span class="n">path</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">-3</span><span class="p">},</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">    </span><span class="n">main_cell</span><span class="o">-&gt;</span><span class="n">robustpath_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>

<span class="w">    </span><span class="n">Polygon</span><span class="o">*</span><span class="w"> </span><span class="n">major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Polygon</span><span class="o">*</span><span class="p">)</span><span class="n">allocate_clear</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Polygon</span><span class="p">));</span>
<span class="w">    </span><span class="o">*</span><span class="n">major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regular_polygon</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">make_tag</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="w">    </span><span class="n">Polygon</span><span class="w"> </span><span class="n">minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rectangle</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mf">-0.1</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">},</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">},</span><span class="w"> </span><span class="n">make_tag</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// Reserve space for all markers in the main cell</span>
<span class="w">    </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path</span><span class="o">-&gt;</span><span class="n">subpath_array</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
<span class="w">    </span><span class="n">main_cell</span><span class="o">-&gt;</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">ensure_slots</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int64_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Polygon</span><span class="o">*</span><span class="w"> </span><span class="n">poly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Polygon</span><span class="o">*</span><span class="p">)</span><span class="n">allocate_clear</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Polygon</span><span class="p">));</span>
<span class="w">        </span><span class="n">poly</span><span class="o">-&gt;</span><span class="n">copy_from</span><span class="p">(</span><span class="o">*</span><span class="n">major</span><span class="p">);</span>
<span class="w">        </span><span class="n">poly</span><span class="o">-&gt;</span><span class="n">translate</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">position</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">));</span>
<span class="w">        </span><span class="n">main_cell</span><span class="o">-&gt;</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">poly</span><span class="p">);</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int64_t</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">poly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Polygon</span><span class="o">*</span><span class="p">)</span><span class="n">allocate_clear</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Polygon</span><span class="p">));</span>
<span class="w">            </span><span class="n">poly</span><span class="o">-&gt;</span><span class="n">copy_from</span><span class="p">(</span><span class="n">minor</span><span class="p">);</span>
<span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">4.0</span><span class="p">;</span>
<span class="w">            </span><span class="n">poly</span><span class="o">-&gt;</span><span class="n">rotate</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">gradient</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">).</span><span class="n">angle</span><span class="p">(),</span><span class="w"> </span><span class="n">Vec2</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">});</span>
<span class="w">            </span><span class="n">poly</span><span class="o">-&gt;</span><span class="n">translate</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">position</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">));</span>
<span class="w">            </span><span class="n">main_cell</span><span class="o">-&gt;</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">poly</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Last marker: we use the original major marker</span>
<span class="w">    </span><span class="n">major</span><span class="o">-&gt;</span><span class="n">translate</span><span class="p">(</span><span class="n">path</span><span class="o">-&gt;</span><span class="n">end_point</span><span class="p">);</span>
<span class="w">    </span><span class="n">main_cell</span><span class="o">-&gt;</span><span class="n">polygon_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">major</span><span class="p">);</span>
<span class="w">    </span><span class="n">minor</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>

<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">write_gds</span><span class="p">(</span><span class="s">&quot;path_markers.gds&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">free_all</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<img alt="_images/path_markers.svg" class="align-center" src="_images/path_markers.svg" />
</section>
<section id="connection-pads">
<h2>Connection Pads<a class="headerlink" href="#connection-pads" title="Link to this heading"></a></h2>
<p>In this example, a custom end function is used to provide connection pads for
electrical traces.  For simplicity, it assumes that the path width does not
change in the first and last segments, which also must be long enough to
support the pad shapes, and that the pad diameter is larger than the path
width.  The point where the pad connects to the trace can, optionally, be
filleted.</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--10-input--1" name="tab-set--10" type="radio" /><label class="tab-label" for="tab-set--10-input--1">Python</label><div class="tab-content docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gdstk</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">filleted_pad</span><span class="p">(</span><span class="n">pad_radius</span><span class="p">,</span> <span class="n">fillet_radius</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_f</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">v1</span><span class="p">):</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p0</span><span class="p">)</span>
            <span class="n">v0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
            <span class="n">v1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>

            <span class="n">half_trace_width</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">p0</span> <span class="o">-</span> <span class="n">p1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">half_trace_width</span> <span class="o">+</span> <span class="n">fillet_radius</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">pad_radius</span> <span class="o">+</span> <span class="n">fillet_radius</span>
            <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">a</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">a</span> <span class="o">/</span> <span class="n">c</span><span class="p">)</span>
            <span class="n">gamma</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span>

            <span class="n">curve</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Curve</span><span class="p">(</span><span class="n">p0</span> <span class="o">-</span> <span class="n">v0</span> <span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="n">tolerance</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fillet_radius</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">curve</span><span class="o">.</span><span class="n">arc</span><span class="p">(</span><span class="n">fillet_radius</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span>
            <span class="n">curve</span><span class="o">.</span><span class="n">arc</span><span class="p">(</span><span class="n">pad_radius</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">+</span> <span class="n">alpha</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fillet_radius</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">curve</span><span class="o">.</span><span class="n">arc</span><span class="p">(</span><span class="n">fillet_radius</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">curve</span><span class="o">.</span><span class="n">points</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">_f</span>

    <span class="n">main</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Cell</span><span class="p">(</span><span class="s2">&quot;Main&quot;</span><span class="p">)</span>

    <span class="c1"># Create a bus with 4 traces</span>
    <span class="n">bus</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">FlexPath</span><span class="p">(</span>
        <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">)],</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">joins</span><span class="o">=</span><span class="s2">&quot;round&quot;</span><span class="p">,</span> <span class="n">ends</span><span class="o">=</span><span class="n">filleted_pad</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">bus</span><span class="o">.</span><span class="n">segment</span><span class="p">((</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">offset</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">bus</span><span class="o">.</span><span class="n">segment</span><span class="p">([(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="mi">50</span><span class="p">)])</span>
    <span class="n">bus</span><span class="o">.</span><span class="n">segment</span><span class="p">((</span><span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">offset</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">main</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">bus</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--10-input--2" name="tab-set--10" type="radio" /><label class="tab-label" for="tab-set--10-input--2">C++</label><div class="tab-content docutils container">
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;math.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;gdstk/gdstk.hpp&gt;</span>

<span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">gdstk</span><span class="p">;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">FilletedPadData</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">pad_radius</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">fillet_radius</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">tolerance</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">Array</span><span class="o">&lt;</span><span class="n">Vec2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">filleted_pad</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Vec2</span><span class="w"> </span><span class="n">p0</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Vec2</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Vec2</span><span class="w"> </span><span class="n">p1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">Vec2</span><span class="w"> </span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">FilletedPadData</span><span class="o">*</span><span class="w"> </span><span class="n">pad_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">FilletedPadData</span><span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">pad_radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pad_data</span><span class="o">-&gt;</span><span class="n">pad_radius</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">fillet_radius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pad_data</span><span class="o">-&gt;</span><span class="n">fillet_radius</span><span class="p">;</span>

<span class="w">    </span><span class="n">Vec2</span><span class="w"> </span><span class="n">dp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">p1</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">half_trace_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">dp</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dp</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dp</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dp</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">half_trace_width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">fillet_radius</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pad_radius</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">fillet_radius</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="p">);</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">acos</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">c</span><span class="p">);</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">gamma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atan2</span><span class="p">(</span><span class="n">v0</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">M_PI</span><span class="p">;</span>

<span class="w">    </span><span class="n">Curve</span><span class="w"> </span><span class="n">curve</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="n">curve</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">p0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">pad_data</span><span class="o">-&gt;</span><span class="n">tolerance</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fillet_radius</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">curve</span><span class="p">.</span><span class="n">arc</span><span class="p">(</span><span class="n">fillet_radius</span><span class="p">,</span><span class="w"> </span><span class="n">fillet_radius</span><span class="p">,</span><span class="w"> </span><span class="n">gamma</span><span class="p">,</span><span class="w"> </span><span class="n">gamma</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">alpha</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">curve</span><span class="p">.</span><span class="n">arc</span><span class="p">(</span><span class="n">pad_radius</span><span class="p">,</span><span class="w"> </span><span class="n">pad_radius</span><span class="p">,</span><span class="w"> </span><span class="n">gamma</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">M_PI</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">alpha</span><span class="p">,</span><span class="w"> </span><span class="n">gamma</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">alpha</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fillet_radius</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">curve</span><span class="p">.</span><span class="n">arc</span><span class="p">(</span><span class="n">fillet_radius</span><span class="p">,</span><span class="w"> </span><span class="n">fillet_radius</span><span class="p">,</span><span class="w"> </span><span class="n">gamma</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">M_PI</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">alpha</span><span class="p">,</span><span class="w"> </span><span class="n">gamma</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">M_PI</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">curve</span><span class="p">.</span><span class="n">point_array</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Library</span><span class="w"> </span><span class="n">lib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="s">&quot;library&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">1e-6</span><span class="p">,</span><span class="w"> </span><span class="mf">1e-9</span><span class="p">);</span>

<span class="w">    </span><span class="n">Cell</span><span class="o">*</span><span class="w"> </span><span class="n">main_cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Cell</span><span class="o">*</span><span class="p">)</span><span class="n">allocate_clear</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Cell</span><span class="p">));</span>
<span class="w">    </span><span class="n">main_cell</span><span class="o">-&gt;</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">copy_string</span><span class="p">(</span><span class="s">&quot;Main&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">cell_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">main_cell</span><span class="p">);</span>

<span class="w">    </span><span class="n">FlexPath</span><span class="o">*</span><span class="w"> </span><span class="n">bus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">FlexPath</span><span class="o">*</span><span class="p">)</span><span class="n">allocate_clear</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">FlexPath</span><span class="p">));</span>
<span class="w">    </span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">},</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="mf">0.01</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">FilletedPadData</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mf">0.01</span><span class="p">};</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int64_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">join_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JoinType</span><span class="o">::</span><span class="n">Round</span><span class="p">;</span>
<span class="w">        </span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">end_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EndType</span><span class="o">::</span><span class="n">Function</span><span class="p">;</span>
<span class="w">        </span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">end_function</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filleted_pad</span><span class="p">;</span>
<span class="w">        </span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">end_function_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">data</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">},</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">offsets1</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">-9</span><span class="p">,</span><span class="w"> </span><span class="mi">-3</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">};</span>
<span class="w">    </span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">},</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">offsets1</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="w">    </span><span class="n">Vec2</span><span class="w"> </span><span class="n">points</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mi">80</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">}};</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">Array</span><span class="o">&lt;</span><span class="n">Vec2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">point_array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{.</span><span class="n">capacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">COUNT</span><span class="p">(</span><span class="n">points</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="n">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">points</span><span class="p">};</span>
<span class="w">    </span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">(</span><span class="n">point_array</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">offsets2</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">-18</span><span class="p">,</span><span class="w"> </span><span class="mi">-6</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="p">};</span>
<span class="w">    </span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">segment</span><span class="p">(</span><span class="n">Vec2</span><span class="p">{</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">},</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">offsets2</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>

<span class="w">    </span><span class="n">main_cell</span><span class="o">-&gt;</span><span class="n">flexpath_array</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>

<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">write_gds</span><span class="p">(</span><span class="s">&quot;pads.gds&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="n">lib</span><span class="p">.</span><span class="n">free_all</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<img alt="_images/pads.svg" class="align-center" src="_images/pads.svg" />
</section>
<section id="system-fonts">
<h2>System Fonts<a class="headerlink" href="#system-fonts" title="Link to this heading"></a></h2>
<p>This example uses <a class="reference external" href="https://matplotlib.org/">matplotlib</a> to render text using
any typeface present in the system.  The glyph paths are then transformed into
polygon arrays that can be used to create <a class="reference internal" href="geometry/gdstk.Polygon.html#gdstk.Polygon" title="gdstk.Polygon"><code class="xref py py-class docutils literal notranslate"><span class="pre">gdstk.Polygon</span></code></a> objects.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">gdstk</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.font_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">FontProperties</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.textpath</span><span class="w"> </span><span class="kn">import</span> <span class="n">TextPath</span>


<span class="k">def</span><span class="w"> </span><span class="nf">render_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">font_prop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
    <span class="n">precision</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">tolerance</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">TextPath</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="n">font_prop</span><span class="p">)</span>
    <span class="n">polys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">xmax</span> <span class="o">=</span> <span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">points</span><span class="p">,</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">iter_segments</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="n">path</span><span class="o">.</span><span class="n">MOVETO</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Curve</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="n">tolerance</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="n">path</span><span class="o">.</span><span class="n">LINETO</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">segment</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="n">path</span><span class="o">.</span><span class="n">CURVE3</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">quadratic</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="n">path</span><span class="o">.</span><span class="n">CURVE4</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">cubic</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="n">path</span><span class="o">.</span><span class="n">CLOSEPOLY</span><span class="p">:</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">points</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">pts</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">poly</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span><span class="n">pts</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pts</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">xmax</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">polys</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">polys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">contain_any</span><span class="p">(</span><span class="o">*</span><span class="n">poly</span><span class="o">.</span><span class="n">points</span><span class="p">):</span>
                            <span class="n">p</span> <span class="o">=</span> <span class="n">polys</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                            <span class="n">poly</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">boolean</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">poly</span><span class="p">,</span> <span class="s2">&quot;xor&quot;</span><span class="p">,</span> <span class="n">precision</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">break</span>
                        <span class="k">elif</span> <span class="n">poly</span><span class="o">.</span><span class="n">contain_any</span><span class="p">(</span><span class="o">*</span><span class="n">polys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">points</span><span class="p">):</span>
                            <span class="n">p</span> <span class="o">=</span> <span class="n">polys</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                            <span class="n">poly</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">boolean</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">poly</span><span class="p">,</span> <span class="s2">&quot;xor&quot;</span><span class="p">,</span> <span class="n">precision</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="n">xmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">poly</span><span class="o">.</span><span class="n">points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
                <span class="n">polys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">polys</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">cell</span> <span class="o">=</span> <span class="n">gdstk</span><span class="o">.</span><span class="n">Cell</span><span class="p">(</span><span class="s2">&quot;fonts&quot;</span><span class="p">)</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">FontProperties</span><span class="p">(</span><span class="n">family</span><span class="o">=</span><span class="s2">&quot;serif&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;italic&quot;</span><span class="p">)</span>
    <span class="n">polygons</span> <span class="o">=</span> <span class="n">render_text</span><span class="p">(</span><span class="s2">&quot;Text rendering&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">font_prop</span><span class="o">=</span><span class="n">fp</span><span class="p">)</span>
    <span class="n">cell</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">*</span><span class="n">polygons</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/fonts.svg" class="align-center" src="_images/fonts.svg" />
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="gettingstarted.html" class="btn btn-neutral float-left" title="Getting Started" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="reference_python.html" class="btn btn-neutral float-right" title="Python API Reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Lucas H. Gabrielli.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>